package gomantlr;

import tom.gom.adt.gom.types.*;

import antlrgrammar.types.*;

import antlrgrammar.antlrrules.types.*;
import antlrgrammar.antlrelement.types.*;

import antlrgrammar.antlrcommons.types.AntlrId;

public class GenerateGom {

    %include { ../antlrgrammar/AntlrGrammar.tom }
    %include { adt/gom/Gom.tom}

    private static class Container {
        public String classPrefix="Gomantlr";
        public String varPrefix="gomantlr";

        public String prefixSeparator="_";
        public String suffixSeparator="_";

        public String grammarName;

        public boolean charUsed=false;
        public boolean stringUsed=false;

        public GomTypeList typeList=`concGomType();
        public GomTypeList lexerTypeList=`concGomType();

        public ProductionList lexerProductionList=`concProduction();
    }
    
    public static GomModule generateGom(AntlrGrammar grammar) {
        Container container=new Container();

        // We're only interested in rules for now.
        %match(grammar) {
            AntlrGrammar(_,AntlrId(name),_,_,_,_,_,rules) -> {
                container.grammarName=`name;
                ProductionList productionList1=generateGom(`rules,container);
                ProductionList productionList2=container.lexerProductionList;

                ImportList importList=null;

                if(container.charUsed) {
                    importList=`concImportedModule(Import(GomModuleName("char")));
                }
                
                if(container.stringUsed) {
                    if(importList==null) {
                        importList=`concImportedModule(Import(GomModuleName("String")));
                    } else {
                        importList=`concImportedModule(importList*,Import(GomModuleName("String")));
                    }
                }
                
                SectionList sectionList=`concSection(Public(concGrammar(Sorts(container.typeList),Grammar(concProduction(productionList1*,productionList2*)))));

                if(importList!=null) {
                    sectionList=`concSection(Imports(importList),sectionList*);
                }

                return
                    `GomModule(
                        GomModuleName(container.classPrefix+container.prefixSeparator+container.grammarName),
                        sectionList);
            }
        }
        
        return null;
    }

    private static ProductionList generateGom(AntlrRules rules,Container container) {
        %match(rules) {
            AntlrRules(x,y*) -> {
                ProductionList productionList1=generateGom(`x,container);
                ProductionList productionList2=generateGom(`y,container);
                return `concProduction(productionList1*,productionList2*);
            }
        }

        return `concProduction();
    }

    private static ProductionList generateGom(AntlrRule rule,Container container) {
        %match(rule) {
            AntlrRule(AntlrId(name),_,_,_,_,_,_,element,_) -> {
                String radix=container.grammarName+container.suffixSeparator+`name;
                String type=container.classPrefix+container.prefixSeparator+radix;

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                return generateElementGom(`element,`name,type,container);
            }
        }

        return `concProduction();
    }

    private static ProductionList generateElementGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        ProductionList productionList;
        Production production;
        Field field;
        String radix;
        String type;

        %match(element) {
            AntlrBlock(_,_,x) -> {
                return generateElementGom(`x,ruleName,ruleType,container);
            }
            AntlrOptional[] -> {
                return generateOptionalGom(element,ruleName,ruleType,container);
            }
            AntlrClosure[] -> {
                return generateClosureGom(element,ruleName,ruleType,container);
            }
            AntlrPositiveClosure[] -> {
                return generatePositiveClosureGom(element,ruleName,ruleType,container);
            }
            AntlrOrElement(_*) -> {
                // This "if" should be generated by %match()
                if (element.isEmptyAntlrOrElement() || element.isConsAntlrOrElement()) {
                    return generateOrElementGom(element,ruleName,ruleType,container);
                }
            }
            AntlrAndElement(_*) -> {
                // This "if" should be generated by %match()
                if (element.isEmptyAntlrAndElement() || element.isConsAntlrAndElement()) {
                    return generateAndElementGom(element,ruleName,ruleType,container);
                }
            }
            AntlrNotElement[] -> {
                return generateNotElementGom(element,ruleName,ruleType,container);
            }
            AntlrRuleRef(name) -> {
                radix=container.grammarName+container.suffixSeparator+`name;
                type=container.classPrefix+container.prefixSeparator+radix;

                field=
                    `NamedField(
                         container.varPrefix+container.prefixSeparator+radix,
                         GomType(type));
                                  
                production=`Production(ruleType,concField(field),GomType(ruleType));

                return `concProduction(production);
            }
            AntlrToken(name) -> {
                radix=container.grammarName+container.suffixSeparator+`name;
                type=container.classPrefix+container.prefixSeparator+radix;

                field=
                    `NamedField(
                         container.varPrefix+container.prefixSeparator+radix,
                         GomType(type));
                                  
                container.stringUsed=true;
                production=`Production(ruleType,concField(field),GomType(ruleType));

                addUsedToken(type,container);

                return `concProduction(production);
            }
            AntlrStringElement[] -> {
                production=`Production(ruleType,concField(),GomType(ruleType));
                
                return `concProduction(production);
            }
            AntlrCharElement[] -> {
                production=`Production(ruleType,concField(),GomType(ruleType));

                return `concProduction(production);
            }
            AntlrCharRange[] -> {
                production=`Production(ruleType,concField(),GomType(ruleType));

                return `concProduction(production);
            }
            AntlrActionElement[] -> {
                // just ignore
                return `concProduction();
            }
            AntlrWildcard() -> {
                field=`NamedField("c",GomType("char"));

                container.charUsed=true;
                                  
                production=`Production(ruleType,concField(field),GomType(ruleType));

                return `concProduction(production);
            }
            AntlrEpsilon() -> {
                production=`Production(ruleType,concField(),GomType(ruleType));

                return `concProduction(production);
            }
        }

        System.out.println("Unexpected element: "+element);
        return `concProduction();
    }

    private static ProductionList generateAndElementGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        return generateAndElementGom(element,ruleName,ruleType,`concField(),`concProduction(),1,container);
    }

    private static ProductionList generateAndElementGom(AntlrElement element,String ruleName,String ruleType,FieldList fieldList,ProductionList productionList,int num,Container container) {
        %match(element) {
            AntlrAndElement() -> {
                Production production=`Production(ruleType,fieldList,GomType(ruleType));

                return `concProduction(production,productionList*);
            }
            AntlrAndElement(x,y*) -> {
                String radix=container.grammarName+container.suffixSeparator+ruleName+container.suffixSeparator+num;

                String type=container.classPrefix+container.prefixSeparator+radix;

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                Field field=
                    `NamedField(
                       container.varPrefix+container.prefixSeparator+radix,
                       GomType(type));

                ProductionList productionList2=generateElementGom(`x,ruleName+container.suffixSeparator+num,type,container);

                return generateAndElementGom(`y,ruleName,ruleType,`concField(fieldList*,field),`concProduction(productionList*,productionList2*),num+1,container);
            }
        }

        System.out.println("Unexpected AndElement: "+element);
        return `concProduction();
    }

    private static ProductionList generateOrElementGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        return generateOrElementGom(element,ruleName,ruleType,`concProduction(),1,container);
    }

    private static ProductionList generateOrElementGom(AntlrElement element,String ruleName,String ruleType,ProductionList productionList,int num,Container container) {
        %match(element) {
            AntlrOrElement() -> {
                return productionList;
            }
            AntlrOrElement(x,y*) -> {
                String radix=container.grammarName+container.suffixSeparator+ruleName+container.suffixSeparator+num;

                String type=container.classPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1";

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                Field field=
                    `NamedField(
                       container.varPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1",
                       GomType(type));

                Production production=`Production(ruleType+container.suffixSeparator+num,concField(field),GomType(ruleType));

                ProductionList productionList1=generateElementGom(`x,ruleName+container.suffixSeparator+num+container.suffixSeparator+"1",type,container);
                ProductionList productionList2=generateOrElementGom(`y,ruleName,ruleType,`concProduction(productionList*,productionList1*),num+1,container);

                return `concProduction(production,productionList2*);
            }
        }

        System.out.println("Unexpected OrElement: "+element);
        return `concProduction();
    }

    private static ProductionList generateOptionalGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        %match(element) {
            AntlrOptional(x) -> {
                String radix=container.grammarName+container.suffixSeparator+ruleName+container.suffixSeparator+"1";

                String type=container.classPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1";

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                Field field=
                    `NamedField(
                       container.varPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1",
                       GomType(type));

                Production production1=`Production(ruleType+container.suffixSeparator+"1",concField(field),GomType(ruleType));
                Production production2=`Production(ruleType+container.suffixSeparator+"2",concField(),GomType(ruleType));

                ProductionList productionList1=`concProduction(production1,production2);

                ProductionList productionList2=generateElementGom(`x,ruleName+container.suffixSeparator+"1"+container.suffixSeparator+"1",type,container);

                return `concProduction(productionList1*,productionList2*);
            }
        }

        System.out.println("Unexpected Optional: "+element);
        return `concProduction();
    }

    private static ProductionList generateClosureGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        %match(element) {
            AntlrClosure(x) -> {
                String radix=container.grammarName+container.suffixSeparator+ruleName+container.suffixSeparator+"1";

                String type=container.classPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1";

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                Field field=
                    `StarredField(GomType(type));

                Production production=`Production(ruleType+container.suffixSeparator+"1",concField(field),GomType(ruleType));

                ProductionList productionList1=`concProduction(production);
                ProductionList productionList2=generateElementGom(`x,ruleName+container.suffixSeparator+"1"+container.suffixSeparator+"1",type,container);

                return `concProduction(productionList1*,productionList2*);
            }
        }

        System.out.println("Unexpected Closure: "+element);
        return `concProduction();
    }

    private static ProductionList generatePositiveClosureGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        // We don't have "foo+" in gom, thus we do "foo*"
        %match(element) {
            AntlrPositiveClosure(x) -> {
                String radix=container.grammarName+container.suffixSeparator+ruleName+container.suffixSeparator+"1";

                String type=container.classPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1";

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                Field field=
                    `StarredField(GomType(type));

                Production production=`Production(ruleType+container.suffixSeparator+"1",concField(field),GomType(ruleType));

                ProductionList productionList1=`concProduction(production);
                ProductionList productionList2=generateElementGom(`x,ruleName+container.suffixSeparator+"1"+container.suffixSeparator+"1",type,container);

                return `concProduction(productionList1*,productionList2*);
            }
        }

        System.out.println("Unexpected PositiveClosure: "+element);
        return `concProduction();
    }

    private static ProductionList generateNotElementGom(AntlrElement element,String ruleName,String ruleType,Container container) {
        %match(element) {
            AntlrNotElement(x) -> {
                String radix=container.grammarName+container.suffixSeparator+ruleName+container.suffixSeparator+"1";

                String type=container.classPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1";

                GomTypeList typeList=container.typeList;
                container.typeList=`concGomType(GomType(type),typeList*);

                Field field=
                    `NamedField(
                       container.varPrefix+container.prefixSeparator+radix+container.suffixSeparator+"1",
                       GomType(type));

                Production production=`Production(ruleType+container.suffixSeparator+"1",concField(field),GomType(ruleType));

                ProductionList productionList2=generateElementGom(`x,ruleName+container.suffixSeparator+"1"+container.suffixSeparator+"1",type,container);

                return `concProduction(production,productionList2*);
            }
        }

        System.out.println("Unexpected Optional: "+element);
        return `concProduction();
    }

    private static void addUsedToken(String type,Container container) {
        ProductionList productionList=container.lexerProductionList;

        %match(productionList) {
            concProduction(_*,Production(name,_,_),_*) -> {
                if(`name.equals(type)) {
                    return;
                }
            }
        }

        Field field=`NamedField("s",GomType("String"));
        Production production=`Production(type,concField(field),GomType(type));

        GomTypeList typeList=container.lexerTypeList;
        container.typeList=`concGomType(GomType(type),typeList*);

        container.lexerProductionList=`concProduction(productionList*,production);
    }
}
