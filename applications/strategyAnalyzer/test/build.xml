<?xml version="1.0"?>

<project default="junit" basedir=".">
	<property name="classpath" location="../../../src/dist/lib/tom-runtime-full.jar"/>
	<property name="tom.home" location="../../../src/dist"/>
	<property name="test.dir" location="."/>
	<property name="test.build" location="${test.dir}/build"/>
	<property name="test.gen" location="${test.dir}/gen"/>
	<property name="test.dist" location="${test.dir}/dist"/>
  
	<import file="${tom.home}/lib/tom-common.xml"/>

  	<path id="tom.classpath">
    		<path refid="external.classpath"/>
   		<fileset dir="${tom.home}/lib">
   			<include name="**/*.jar"/>
    		</fileset>
 	</path>

	<taskdef resource="net/sf/antcontrib/antlib.xml">
    		<classpath>
          		<fileset file="${tom.home}/lib/compiletime/ant-contrib-1.0b3.jar"/>
 		</classpath>
	</taskdef>

	<target name="clean">
		<delete dir="${test.build}"/>
		<delete dir="${test.gen}"/>
		<delete dir="${test.dist}"/>
	</target>

	<target name="init" depends="tom.init">
		<mkdir dir="${test.build}"/>
		<mkdir dir="${test.gen}"/>
		<mkdir dir="${test.dist}"/>
		<javac srcdir="${test.dir}" destdir="${test.build}" includeantruntime="false"/>
		<jar destfile="${test.dist}/runningTests.jar">
			<fileset dir="${test.build}" includes="*.class"/>
		</jar>
				
	</target>	

	<target name="junit" depends="init">
		<for param="file"> 
			<path>
				<fileset dir="${test.dir}" includes="*.ns"/>
			</path>
			<sequential>
				<basename property="nsNameOf@{file}" file="@{file}" suffix=".ns"/>
				<java classpath="../build:${classpath}" classname="sa.Main" fork="true">
					<arg value="-i"/>
					<arg file="@{file}"/>
					<arg value="-d"/>
					<arg value="${test.gen}"/>
					<arg value="-tom"/>
					<arg value="Main${nsNameOf@{file}}"/>
			
	        		</java>
			</sequential>
		</for>
		<antcall target="runTests"/>
	</target>

	<target name="junit.typed" depends="init">
		<for param="file"> 
			<path>
				<fileset dir="${test.dir}" includes="*.ns"/>
			</path>
			<sequential>
				<basename property="nsNameOf@{file}" file="@{file}" suffix=".ns"/>
				<java classpath="../build:${classpath}" classname="sa.Main" fork="true">
					<arg value="-i"/>
					<arg file="@{file}"/>
					<arg value="-d"/>
					<arg value="${test.gen}"/>
					<arg value="-tom"/>
					<arg value="Main${nsNameOf@{file}}"/>
					<arg value="-withType"/>	
			
	        		</java>
			</sequential>
		</for>
		<antcall target="runTests"/>
	</target>

	<target name="junit.metalevel" depends="init">
		<for param="file"> 
			<path>
				<fileset dir="${test.dir}" includes="*.ns"/>
			</path>
			<sequential>
				<basename property="nsNameOf@{file}" file="@{file}" suffix=".ns"/>
				<java classpath="../build:${classpath}" classname="sa.Main" fork="true">
					<arg value="-i"/>
					<arg file="@{file}"/>
					<arg value="-metalevel"/>
					<arg value="-d"/>
					<arg value="${test.gen}"/>
					<arg value="-tom"/>
					<arg value="Main${nsNameOf@{file}}"/>
	        		</java>
			</sequential>
		</for>
		<antcall target="runTests"/>
	</target>

	<target name="junit.ordered" depends="init">
		<for param="file"> 
			<path>
				<fileset dir="${test.dir}" includes="*.ns"/>
			</path>
			<sequential>
				<basename property="nsNameOf@{file}" file="@{file}" suffix=".ns"/>
				<java classpath="../build:${classpath}" classname="sa.Main" fork="true">
					<arg value="-i"/>
					<arg file="@{file}"/>
					<arg value="-ordered"/>
					<arg value="-d"/>
					<arg value="${test.gen}"/>
					<arg value="-tom"/>
					<arg value="Main${nsNameOf@{file}}"/>
	        		</java>
			</sequential>
		</for>
		<antcall target="runTests"/>
	</target>

	<target name="tomSrc">
		<tom.preset srcdir="${test.gen}" destdir="${test.gen}"> 
   			<include name="*.t"/>
			<exclude name="*Test*.t"/> 
    		</tom.preset>
	</target> 

	<target name="tomTest" depends="tomSrc">
		<tom.preset srcdir="${test.dir}" destdir="${test.gen}">
			<include name="*Test*.t"/>
		</tom.preset>
	</target>
	
	<target name="compile" depends="tomTest">
		<javac classpath="${test.dir}:${test.dist}/*.jar:${tom.home}/lib/tom-runtime-full.jar:${tom.home}/lib/compiletime/junit.jar" srcdir="${test.gen}" destdir="${test.build}" includeantruntime="false"/>
	</target>	
	
	<target name="runTests" depends="compile">
		<for param="file">
			<path>
				<fileset dir="${test.build}" includes="*Test*.class"/>
			</path>
			<sequential>
				<basename property="classOf@{file}" file="@{file}" suffix=".class"/>
				<echo> Running test : ${classOf@{file}} </echo>
				<java classpath=".:${test.build}:${tom.home}/lib/tom-runtime-full.jar:${tom.home}/lib/compiletime/junit.jar" classname="org.junit.runner.JUnitCore">
					<arg value="${classOf@{file}}"/>
				</java> 
			</sequential>
		</for>
	</target>
</project>
