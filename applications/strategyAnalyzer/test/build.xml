<?xml version="1.0"?>

<project default="untyped" basedir=".">
	<property name="classpath" location="../../../src/dist/lib/tom-runtime-full.jar"/>
	<property name="tom.home" location="../../../src/dist"/>
	<property name="test.dir" location="."/>
	<property name="test.test" location="${test.dir}/test"/>
	<property name="test.src" location="${test.dir}/src"/>
	<property name="test.build" location="${test.dir}/build"/>
	<property name="build.tom" location="${test.build}/tom"/>
	<property name="build.src" location="${test.build}/src"/>
	<property name="build.bin" location="${test.build}/bin"/>
  
	<import file="${tom.home}/lib/tom-common.xml"/>

  	<path id="tom.classpath">
    		<path refid="external.classpath"/>
   		<fileset dir="${tom.home}/lib">
   			<include name="**/*.jar"/>
    		</fileset>
 	</path>

	<target name="clean">
		<delete dir="${test.build}"/>
	</target>

	<target name="init" depends="tom.init">
		<mkdir dir="${test.build}"/>
		<mkdir dir="${build.tom}"/>
		<mkdir dir="${build.src}"/>
		<mkdir dir="${build.bin}"/>
	</target>	

	<target name="typed" depends="init">
		<java classpath="../build:${classpath}" classname="sa.Main" fork="true">
			<arg value="-i"/>
			<arg file="${test.src}/gxx.ns"/>
			<arg value="-tom"/>
			<arg value="Gxx"/>
			<arg value="-typed"/>
			<arg value="T"/>
	        </java>
		<antcall target="runTests"/>
	</target>

	<target name="untyped" depends="init">
		<java classpath="../build:${classpath}" classname="sa.Main" fork="true">
			<arg value="-i"/>
			<arg file="${test.src}/gxx.ns"/>
			<arg value="-tom"/>
			<arg value="Gxx"/>
		</java>
		<antcall target="runTests"/>
	</target>

	<target name="tomSrc">
		<move file="Gxx.t" todir="${build.tom}"/>
		<tom.preset srcdir="${build.tom}" destdir="${build.src}"> 
   			<include name="*.t"/>
			<exclude name="*Test*.t"/> 
    		</tom.preset>
	</target> 

	<target name="tomTest" depends="tomSrc">
		<tom.preset srcdir="${test.test}" destdir="${build.src}">
			<include name="*Test*.t"/>
		</tom.preset>
	</target>
	
	<target name="compile" depends="tomTest">
		<javac classpath=".:${tom.home}/lib/tom-runtime-full.jar:${tom.home}/lib/compiletime/junit.jar" srcdir="${build.src}" destdir="${build.bin}" includeantruntime="false"/>
	</target>	
	
	<target name="runTests" depends="compile">
		<java classpath=".:${build.bin}:${tom.home}/lib/tom-runtime-full.jar:${tom.home}/lib/compiletime/junit.jar" classname="org.junit.runner.JUnitCore">
			<arg value="TestGxx"/>
		</java> 
	</target>
</project>
