<?xml version="1.0" encoding="UTF-8"?>
<project name="Ant for Tom-examples" default="examples" basedir=".">
  <description>
    This script prepare a bundle of Tom examples
  </description>

  <property environment="env" />
  <!-- some used directory location -->
  <property name="examples.dir" location="."/>
  <property name="examples.dist" location="dist"/>

  <!-- Examples to build and distribute -->
  <property name="addressbook" value="AddressBook"/>
  <property name="addressbook.dir" location="${examples.dir}/${addressbook}" />

  <property name="apireach" value="ApiReach"/>
  <property name="apireach.dir" location="${examples.dir}/${apireach}" />

  <property name="boulderdash" value="BoulderDash"/>
  <property name="boulderdash.dir" location="${examples.dir}/${boulderdash}" />

  <property name="builtin" value="Builtin"/>
  <property name="builtin.dir" location="${examples.dir}/${builtin}" />

  <property name="caml" value="Caml"/>
  <property name="caml.dir" location="${examples.dir}/${caml}" />

  <property name="dom" value="Dom"/>
  <property name="dom.dir" location="${examples.dir}/${dom}" />

  <property name="expression" value="Expression"/>
  <property name="expression.dir" location="${examples.dir}/${expression}" />

  <property name="gtree" value="GTree"/>
  <property name="gtree.dir" location="${examples.dir}/${gtree}" />

  <property name="integerc" value="IntegerC"/>
  <property name="integerc.dir" location="${examples.dir}/${integerc}" />

  <property name="list" value="List"/>
  <property name="list.dir" location="${examples.dir}/${list}" />

  <property name="lsystem" value="Lsystems"/>
  <property name="lsystem.dir" location="${examples.dir}/${lsystem}" />

  <property name="nspk" value="Nspk"/>
  <property name="nspk.dir" location="${examples.dir}/${nspk}" />

  <property name="peano" value="Peano"/>
  <property name="peano.dir" location="${examples.dir}/${peano}" />

  <property name="pnspk" value="PNspk"/>
  <property name="pnspk.dir" location="${examples.dir}/${pnspk}" />

  <property name="poly" value="Poly"/>
  <property name="poly.dir" location="${examples.dir}/${poly}" />

  <property name="pqueens" value="PQueens"/>
  <property name="pqueens.dir" location="${examples.dir}/${pqueens}" />

  <property name="rbtree" value="RBTree"/>
  <property name="rbtree.dir" location="${examples.dir}/${rbtree}" />

  <property name="set" value="Set"/>
  <property name="set.dir" location="${examples.dir}/${set}" />

  <property name="vas" value="Vas"/>
  <property name="vas.dir" location="${examples.dir}/${vas}" />

  <property name="xml" value="Xml"/>
  <property name="xml.dir" location="${examples.dir}/${xml}" />

  <!-- Define classpath for building stable and source  -->
  <path id="tom.classpath">
    <fileset dir="${env.TOM_HOME}/lib">
      <include name="*.jar"/>
    </fileset>
  </path>
  
  <!-- tasks for building -->
  <taskdef name="adt" 
           classname="jtom.tools.ant.ApigenTask"
           classpathref="tom.classpath"/>
  <taskdef name="tom" 
           classname="jtom.tools.ant.TomTask"
           classpathref="tom.classpath"/>

  <target name="prepare.examples">
    <mkdir dir="${examples.dist}"/>
  </target>
  
  <!-- target debug to help finding properties problems -->
  <target name="debug"> 
    <echoproperties/>
  </target>

  <target name="clean.examples" description="Cleans examples directory">
    <delete>
      <fileset dir="${examples.dir}" includes="**/*.class" />
    </delete>
    <!-- deletes java files generated by tom -->
    <delete>
      <fileset dir="${examples.dir}" includes="**/*.java">
        <present targetdir="${examples.dir}">
          <mapper type="glob" from="*.java" to="*.t"/>
        </present>
      </fileset>
    </delete>
  </target>

  <target name="addressbook">
    <!-- build adt -->
    <adt file="${addressbook.dir}/data.adt" 
         factory="data" 
         package="AddressBook" 
				 outputtomdir="${addressbook.dir}"
         outputdir="${examples.dir}"/>
    <!-- build tom -->
    <tom srcdir="${addressbook.dir}" 
         destdir="${addressbook.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${addressbook.dir}" destdir="${examples.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="apireach">
    <!-- build adt -->
    <adt file="${apireach.dir}/reach.adt" 
         factory="reach" 
         package="ApiReach" 
         destdir="${examples.dir}"/>
    <!-- build tom -->
    <tom srcdir="${apireach.dir}" 
         destdir="${apireach.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${apireach.dir}" destdir="${examples.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="boulderdash">
    <!-- build adt -->
    <adt file="${boulderdash.dir}/boulder.adt" 
         factory="boulder" 
         package="BoulderDash" 
         destdir="${examples.dir}"/>
    <!-- build tom -->
    <tom srcdir="${boulderdash.dir}" 
         destdir="${boulderdash.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${boulderdash.dir}" destdir="${examples.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="builtin">
    <!-- build adt -->
    <adt file="${builtin.dir}/term.adt" 
         factory="term" 
         package="adt.builtin" 
         destdir="${builtin.dir}"/>
    <!-- build tom -->
    <tom srcdir="${builtin.dir}" 
         destdir="${builtin.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${builtin.dir}" destdir="${builtin.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>
  
  <target name="dom">
    <!-- build tom -->
    <tom srcdir="${dom.dir}" 
         destdir="${dom.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${dom.dir}" destdir="${dom.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>
  
  <target name="expression">
    <!-- build tom -->
    <tom srcdir="${expression.dir}" 
         destdir="${expression.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom --lazyType">
      <include name="**/Record.t"/>
    </tom>
    <tom srcdir="${expression.dir}" 
         destdir="${expression.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/RecordStrict.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${expression.dir}" destdir="${expression.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="gtree">
    <!-- build adt -->
    <adt file="${gtree.dir}/term.adt" 
         factory="term" 
         package="adt.gtree" 
         destdir="${gtree.dir}"/>
    <!-- build tom -->
    <tom srcdir="${gtree.dir}" 
         destdir="${gtree.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${gtree.dir}" destdir="${gtree.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="list">
    <!-- build tom -->
    <tom srcdir="${list.dir}" 
         destdir="${list.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${list.dir}" destdir="${list.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="lsystem">
    <!-- build tom -->
    <tom srcdir="${lsystem.dir}" 
         destdir="${lsystem.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${lsystem.dir}" destdir="${lsystem.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="nspk">
    <!-- build adt -->
    <adt file="${nspk.dir}/term.adt" 
         factory="term" 
         package="adt.nsh" 
         destdir="${nspk.dir}"/>
    <!-- build tom -->
    <tom srcdir="${nspk.dir}" 
         destdir="${nspk.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${nspk.dir}" destdir="${nspk.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>
  
  <target name="peano">
    <!-- build adt -->
    <adt file="${peano.dir}/peano.adt" 
         factory="peano" 
         package="adt.peano" 
         destdir="${peano.dir}"/>
    <!-- build tom -->
    <tom srcdir="${peano.dir}" 
         destdir="${peano.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${peano.dir}" destdir="${peano.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="pnspk">
    <!-- build adt -->
    <adt file="${pnspk.dir}/term.adt" 
         factory="term" 
         package="adt.pnsh" 
         destdir="${pnspk.dir}"/>
    <!-- build tom -->
    <tom srcdir="${pnspk.dir}" 
         destdir="${pnspk.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${pnspk.dir}" destdir="${pnspk.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>
  
  <target name="poly">
    <!-- build adt -->
    <adt file="${poly.dir}/expression.adt" 
         factory="expression" 
         package="adt.poly" 
         destdir="${poly.dir}"/>
    <!-- build tom -->
    <tom srcdir="${poly.dir}" 
         destdir="${poly.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${poly.dir}" destdir="${poly.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="pqueens">
    <!-- build tom -->
    <tom srcdir="${pqueens.dir}" 
         destdir="${pqueens.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${pqueens.dir}" destdir="${pqueens.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="rbtree">
    <!-- build adt -->
    <adt file="${rbtree.dir}/tree.adt" 
         factory="tree" 
         package="adt.rbtree" 
         destdir="${rbtree.dir}"/>
    <!-- build tom -->
    <tom srcdir="${rbtree.dir}" 
         destdir="${rbtree.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${rbtree.dir}" destdir="${rbtree.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="set">
    <!-- build adt -->
    <adt file="${set.dir}/jgset.adt" 
         factory="jgset" 
         package="adt" 
         destdir="${set.dir}"/>
    <!-- build tom -->
    <tom srcdir="${set.dir}" 
         destdir="${set.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${set.dir}" destdir="${set.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="vas">
    <!-- build tom -->
    <tom srcdir="${vas.dir}" 
         destdir="${vas.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${vas.dir}" destdir="${vas.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>

  <target name="xml">
    <!-- build tom -->
    <tom srcdir="${xml.dir}" 
         destdir="${xml.dir}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${xml.dir}" destdir="${xml.dir}">
      <classpath refid="tom.classpath"/>
      <include name="**/*.java"/>
    </javac>
  </target>
  
  
  <target name="examples" 
          description="Builds the examples (at least some)"
          depends="addressbook, apireach, boulderdash, builtin, dom,
					expression, gtree, list, nspk, peano, pnspk, poly, pqueens,
          rbtree, set, vas, xml">
  </target>
  
  <target name="dist.examples" description="Prepare a distribution of examples" depends="prepare.examples">
    <tar tarfile="${examples.dist}/jtom-examples.tar">
      <tarfileset dir="${examples.dir}">
        <include name="README"/>
        <include name="build.xml"/>
        <include name="build.sh"/>

        <include name="${addressbook}/README"/>
        <include name="${addressbook}/*.t"/>
        <include name="${addressbook}/*.adt"/>

        <include name="${apireach}/README"/>
        <include name="${apireach}/*.t"/>
        <include name="${apireach}/*.adt"/>

        <include name="${boulderdash}/README"/>
        <include name="${boulderdash}/*.t"/>
        <include name="${boulderdash}/*.adt"/>
        <include name="${boulderdash}/*.java"/>

        <include name="${builtin}/README"/>
        <include name="${builtin}/*.t"/>
        <include name="${builtin}/*.adt"/>

        <include name="${caml}/README"/>
        <include name="${caml}/*.t"/>
        <include name="${caml}/*.adt"/>
        <include name="${caml}/peanotype.ml"/>
        <include name="${caml}/tomExtension.ml"/>
        <include name="${caml}/tomList.ml"/>

        <include name="${dom}/README"/>
        <include name="${dom}/*.t"/>
        <include name="${dom}/*.adt"/>
        <include name="${dom}/*.xml"/>

        <include name="${expression}/README"/>
        <include name="${expression}/*.t"/>
        <include name="${expression}/*.java"/>

        <include name="${gtree}/README"/>
        <include name="${gtree}/*.t"/>
        <include name="${gtree}/*.adt"/>

        <include name="${integerc}/README"/>
        <include name="${integerc}/*.t"/>
        <include name="${integerc}/*.adt"/>

        <include name="${list}/README"/>
        <include name="${list}/*.t"/>
        <include name="${list}/*.adt"/>

        <include name="${nspk}/README"/>
        <include name="${nspk}/*.t"/>
        <include name="${nspk}/*.adt"/>

        <include name="${peano}/README"/>
        <include name="${peano}/*.t"/>

        <include name="${pnspk}/README"/>
        <include name="${pnspk}/*.t"/>
        <include name="${pnspk}/*.adt"/>

        <include name="${poly}/README"/>
        <include name="${poly}/*.t"/>
        <include name="${poly}/*.adt"/>
        <include name="${poly}/PolyCommon.java"/>
        <include name="${poly}/Poly.signature"/>

        <include name="${pqueens}/README"/>
        <include name="${pqueens}/*.t"/>
        <include name="${pqueens}/*.tom"/>

        <include name="${rbtree}/README"/>
        <include name="${rbtree}/*.t"/>
        <include name="${rbtree}/*.adt"/>

        <include name="${set}/README"/>
        <include name="${set}/*.t"/>
        <include name="${set}/*.adt"/>

        <include name="${vas}/README"/>
        <include name="${vas}/*.t"/>

        <include name="${xml}/README"/>
        <include name="${xml}/*.t"/>
        <include name="${xml}/*.adt"/>
        <include name="${xml}/*.xml"/>
        <include name="${xml}/*.html"/>

        <not>
          <present targetdir="${examples.dir}">
            <mapper type="glob" 
                    from="**/*.java" 
                    to="**/*.t"/>
          </present>
        </not>
      </tarfileset>
    </tar>
    <gzip zipfile="${examples.dist}/jtom-examples.tar.gz" 
          src="${examples.dist}/jtom-examples.tar"/>
    <delete file="${examples.dist}/jtom-examples.tar"/>
  </target>

  <target name="clean.dist" description="Mr proper" depends="clean">
    <delete dir="${examples.dist}"/>
  </target>

  <target name="clean" 
          description="Cleans everything in the project" 
          depends="clean.examples">
  </target> 

	<target name="initjunit">
		<taskdef name="tomjunit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask">
			<classpath refid="tom.classpath"/>
		</taskdef>
	</target>

	<target name="junit" description="Runs junit acceptance tests" depends="examples, initjunit">
		<tomjunit printsummary="on"
							fork="false"
							haltonfailure="false"
							failureproperty="tests.failed"
							showoutput="true">
			<classpath>
				<path refid="tom.classpath"/>
				<pathelement location="${examples.dir}"/>
			</classpath>
			<batchtest>
				<fileset dir="${examples.dir}">
					<include name="**/Test*.java"/>
				</fileset>
			</batchtest>
		</tomjunit>

		<fail if="tests.failed">
****************************************************
****************************************************
  One or more tests failed. Check the output...
****************************************************
****************************************************
		</fail>
	</target>


</project>
