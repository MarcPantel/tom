<?xml version="1.0" encoding="UTF-8"?>
<project name="Ant for Tom-examples" default="dist.examples" basedir=".">
	<description>
		This script prepare a bundle of Tom examples
	</description>

	<property environment="env" />
	<!-- some used directory location -->
	<property name="examples.dir" location="."/>
	<property name="examples.dist" location="dist"/>

	<!-- Examples to build and distribute -->
	<property name="addressbook" value="AddressBook"/>
	<property name="addressbook.dir" location="${examples.dir}/${addressbook}" />

	<property name="boulderdash" value="BoulderDash"/>
	<property name="boulderdash.dir" location="${examples.dir}/${boulderdash}" />

	<property name="builtin" value="Builtin"/>
	<property name="builtin.dir" location="${examples.dir}/${builtin}" />

	<property name="dom" value="Dom"/>
	<property name="dom.dir" location="${examples.dir}/${dom}" />

	<property name="nspk" value="Nspk"/>
	<property name="nspk.dir" location="${examples.dir}/${nspk}" />

	<property name="xml" value="Xml"/>
	<property name="xml.dir" location="${examples.dir}/${xml}" />

	<property name="lsystem" value="Lsystems"/>
	<property name="lsystem.dir" location="${examples.dir}/${lsystem}" />

	<!-- Define classpath for building stable and source	-->
	<path id="tom.classpath">
		<fileset dir="${env.TOM_HOME}/lib">
			<include name="*.jar"/>
		</fileset>
	</path>
	
	<!-- tasks for building -->
	<taskdef name="adt" 
					 classname="jtom.tools.ant.ApigenTask"
					 classpathref="tom.classpath"/>
	<taskdef name="tom" 
					 classname="jtom.tools.ant.TomTask"
					 classpathref="tom.classpath"/>

	<target name="prepare.examples">
		<mkdir dir="${examples.dist}"/>
	</target>
	
	<!-- target debug to help finding properties problems -->
	<target name="debug"> 
		<echoproperties/>
	</target>

	<target name="clean.examples" description="Cleans examples directory">
		<delete>
			<fileset dir="${examples.dir}" includes="**/*.class" />
		</delete>
		<!-- deletes java files generated by tom -->
		<delete>
			<fileset dir="${examples.dir}" includes="**/*.java">
				<present targetdir="${examples.dir}">
					<mapper type="glob" from="*.java" to="*.t"/>
				</present>
			</fileset>
		</delete>
	</target>

	<target name="addressbook">
		<!-- build adt -->
		<adt file="${addressbook.dir}/data.adt" 
				 factory="data" 
				 package="adt.address" 
				 destdir="${addressbook.dir}"/>
		<!-- build tom -->
		<tom srcdir="${addressbook.dir}" 
				 destdir="${addressbook.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${addressbook.dir}" destdir="${addressbook.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>

	<target name="boulderdash">
		<!-- build adt -->
		<adt file="${boulderdash.dir}/boulder.adt" 
				 factory="boulder" 
				 package="adt.boulder" 
				 destdir="${boulderdash.dir}"/>
		<!-- build tom -->
		<tom srcdir="${boulderdash.dir}" 
				 destdir="${boulderdash.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${boulderdash.dir}" destdir="${boulderdash.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>

	<target name="builtin">
		<!-- build adt -->
		<adt file="${builtin.dir}/term.adt" 
				 factory="term" 
				 package="adt.builtin" 
				 destdir="${builtin.dir}"/>
		<!-- build tom -->
		<tom srcdir="${builtin.dir}" 
				 destdir="${builtin.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${builtin.dir}" destdir="${builtin.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>
	
	<target name="dom">
		<!-- build tom -->
		<tom srcdir="${dom.dir}" 
				 destdir="${dom.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${dom.dir}" destdir="${dom.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>
	
	<target name="nspk">
		<!-- build adt -->
		<adt file="${nspk.dir}/term.adt" 
				 factory="term" 
				 package="adt.nsh" 
				 destdir="${nspk.dir}"/>
		<!-- build tom -->
		<tom srcdir="${nspk.dir}" 
				 destdir="${nspk.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${nspk.dir}" destdir="${nspk.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>
	
	<target name="xml">
		<!-- build tom -->
		<tom srcdir="${xml.dir}" 
				 destdir="${xml.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${xml.dir}" destdir="${xml.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>
	
	<target name="lsystem">
		<!-- build tom -->
		<tom srcdir="${lsystem.dir}" 
				 destdir="${lsystem.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${lsystem.dir}" destdir="${lsystem.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>
	
	<target name="build.examples" 
					description="Builds the examples (at least some)"
					depends="addressbook, boulderdash, builtin, dom, nspk, xml">
	</target>
	
	<target name="dist.examples" description="Prepare a
		distribution of examples" depends="prepare.examples">
		<tar tarfile="${examples.dist}/jtom-examples.tar">
			<tarfileset dir="${examples.dir}">
				<include name="${addressbook}/*.t"/>
				<include name="${addressbook}/*.adt"/>

				<include name="${boulderdash}/*.t"/>
				<include name="${boulderdash}/*.adt"/>
				<include name="${boulderdash}/*.java"/>

				<include name="${builtin}/*.t"/>
				<include name="${builtin}/*.adt"/>

				<include name="${dom}/*.t"/>
				<include name="${dom}/*.adt"/>

				<include name="${nspk}/*.t"/>
				<include name="${nspk}/*.adt"/>

				<include name="${xml}/*.t"/>
				<include name="${xml}/*.adt"/>
				<include name="${xml}/*.xml"/>
				<include name="${xml}/*.html"/>

				<not>
					<present targetdir="${examples.dir}">
						<mapper type="glob" 
										from="**/*.java" 
										to="**/*.t"/>
					</present>
				</not>
			</tarfileset>
		</tar>
		<gzip zipfile="${examples.dist}/jtom-examples.tar.gz" 
					src="${examples.dist}/jtom-examples.tar"/>
		<delete file="${examples.dist}/jtom-examples.tar"/>
	</target>

	<target name="clean.dist" description="Mr proper" depends="cleanall">
		<delete dir="${examples.dist}"/>
	</target>

	<target name="cleanall" 
					description="Cleans everything in the project" 
					depends="clean.examples">
	</target>	

</project>
