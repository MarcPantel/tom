<?xml version="1.0" encoding="UTF-8"?>
<project name="Ant for Tom-examples" default="examples" basedir=".">
  <description>
    This script prepare a bundle of Tom examples
  </description>

  <property environment="env" />
  <!-- some used directory location -->
  <property name="examples.dir" location="."/>
  <property name="examples.dist" location="dist"/>

  <!-- where the examples a build: javac destDir -->
  <property name="examples.gen" location="."/>
  <property name="examples.build" location="."/>

  <!-- Examples to build and distribute -->
  <property name="addressbook" value="AddressBook"/>
  <property name="addressbook.dir" location="${examples.dir}/${addressbook}" />

  <property name="apireach" value="ApiReach"/>
  <property name="apireach.dir" location="${examples.dir}/${apireach}" />

  <property name="boulderdash" value="BoulderDash"/>
  <property name="boulderdash.dir" location="${examples.dir}/${boulderdash}" />

  <property name="builtin" value="Builtin"/>
  <property name="builtin.dir" location="${examples.dir}/${builtin}" />

  <property name="caml" value="Caml"/>
  <property name="caml.dir" location="${examples.dir}/${caml}" />

  <property name="dom" value="Dom"/>
  <property name="dom.dir" location="${examples.dir}/${dom}" />

  <property name="expression" value="Expression"/>
  <property name="expression.dir" location="${examples.dir}/${expression}" />

  <property name="gtree" value="GTree"/>
  <property name="gtree.dir" location="${examples.dir}/${gtree}" />

  <property name="integerc" value="IntegerC"/>
  <property name="integerc.dir" location="${examples.dir}/${integerc}" />

  <property name="list" value="List"/>
  <property name="list.dir" location="${examples.dir}/${list}" />

  <property name="lsystem" value="Lsystems"/>
  <property name="lsystem.dir" location="${examples.dir}/${lsystem}" />

  <property name="nspk" value="Nspk"/>
  <property name="nspk.dir" location="${examples.dir}/${nspk}" />

  <property name="peano" value="Peano"/>
  <property name="peano.dir" location="${examples.dir}/${peano}" />

  <property name="pnspk" value="PNspk"/>
  <property name="pnspk.dir" location="${examples.dir}/${pnspk}" />

  <property name="poly" value="Poly"/>
  <property name="poly.dir" location="${examples.dir}/${poly}" />

  <property name="pqueens" value="PQueens"/>
  <property name="pqueens.dir" location="${examples.dir}/${pqueens}" />

  <property name="rbtree" value="RBTree"/>
  <property name="rbtree.dir" location="${examples.dir}/${rbtree}" />

  <property name="set" value="Set"/>
  <property name="set.dir" location="${examples.dir}/${set}" />

  <property name="vas" value="Vas"/>
  <property name="vas.dir" location="${examples.dir}/${vas}" />

  <property name="xml" value="Xml"/>
  <property name="xml.dir" location="${examples.dir}/${xml}" />

  <target name="testdistexist">
    <available file="${env.TOM_HOME}/lib" type="dir" property="distexist"/>
  </target>

									
  <target name="init" if="examples.build">
    <mkdir dir="${examples.build}"/>
    <!-- Define classpath for building stable and source  -->
    <path id="tom.classpath">
      <fileset dir="${env.TOM_HOME}/lib">
        <include name="*.jar"/>
      </fileset>
    </path>
  
    <!-- tasks for building -->
    <taskdef name="adt" 
           classname="jtom.tools.ant.ApigenTask"
           classpathref="tom.classpath"/>
    <taskdef name="tom" 
           classname="jtom.tools.ant.TomTask"
           classpathref="tom.classpath"/>
  </target>
  
  <target name="prepare.examples">
    <mkdir dir="${examples.dist}"/>
  </target>
  
  <!-- target debug to help finding properties problems -->
  <target name="debug"> 
    <echoproperties/>
  </target>

  <target name="clean.examples" description="Cleans examples directory">
    <delete>
      <fileset dir="${examples.dir}" includes="**/*.class" />
    </delete>
    <!-- deletes java files generated by tom -->
    <delete>
      <fileset dir="${examples.dir}" includes="**/*.java">
        <present targetdir="${examples.dir}">
          <mapper type="glob" from="*.java" to="*.t"/>
        </present>
      </fileset>
    </delete>
    <delete>
      <fileset dir="${examples.dir}">
        <include name="**/*.tom"/>
        <exclude name="Caml/mapping.tom"/>
        <exclude name="PQueens/QueensSignature.tom"/>			      
        <exclude name="PQueens/StratSignature.tom"/>
      </fileset>
    </delete>
    <delete dir="${addressbook.dir}/data"/>
    <delete dir="${apireach.dir}/reach"/>
    <delete dir="${boulderdash.dir}/boulder"/>
    <delete dir="${builtin.dir}/term"/>
    <delete dir="${gtree.dir}/term"/>
    <delete dir="${nspk.dir}/term"/>
    <delete dir="${pnspk.dir}/term"/>
    <delete dir="${poly.dir}/expression"/>
    <delete dir="${rbtree.dir}/tree"/>
    <delete dir="${set.dir}/jgset"/>
    <delete dir="${peano.dir}/peano"/>
  </target>

  <target name="addressbook" depends="init">
    <!-- build adt -->
    <adt file="${addressbook.dir}/data.adt" 
         factory="data" 
				 package="${addressbook}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
				 <include name="${addressbook}/**/*.t"/>
			<exclude name="**/AddressBookVas.t"/>
    </tom>
    <!-- build java source -->
		<javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
			<include name="${addressbook}/**/*.java"/>
    </javac>
  </target>

  <target name="apireach" depends="init">
    <!-- build adt -->
    <adt file="${apireach.dir}/reach.adt" 
         factory="reach" 
         package="${apireach}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${apireach}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${apireach}/**/*.java"/>
    </javac>
  </target>

  <target name="boulderdash" depends="init">
    <!-- build adt -->
    <adt file="${boulderdash.dir}/boulder.adt" 
         factory="boulder" 
         package="${boulderdash}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${boulderdash}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac destdir="${examples.build}">
			<src path="${examples.dir}"/>
			<src path="${examples.gen}"/>
      <classpath refid="tom.classpath"/>
      <include name="${boulderdash}/**/*.java"/>
    </javac>
		<!-- copy ressources in build -->
		<copy todir="${examples.build}/${boulderdash}">
			<fileset dir="${examples.dir}/${boulderdash}">
				<include name="*.gif"/>
				<include name="*.html"/>
			</fileset>
		</copy>
  </target>

  <target name="builtin" depends="init">
    <!-- build adt -->
    <adt file="${builtin.dir}/term.adt" 
         factory="term" 
         package="Builtin" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${builtin}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${builtin}/**/*.java"/>
    </javac>
  </target>
  
  <target name="dom" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${dom}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.dir}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${dom}/**/*.java"/>
    </javac>
  </target>
  
  <target name="expression" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom --lazyType">
      <include name="${expression}/**/Record.t"/>
    </tom>
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${expression}/**/RecordStrict.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.dir}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${expression}/**/*.java"/>
    </javac>
  </target>

  <target name="gtree" depends="init">
    <!-- build adt -->
    <adt file="${gtree.dir}/term.adt" 
         factory="term" 
         package="${gtree}" 
         destdir="${examples.dir}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${gtree}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.dir}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${gtree}/**/*.java"/>
    </javac>
  </target>

  <target name="list" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${list}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${list}/**/*.java"/>
    </javac>
  </target>

  <target name="lsystem" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${lsystem}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.dir}">
      <classpath refid="tom.classpath"/>
      <include name="${lsystem}/**/*.java"/>
    </javac>
  </target>

  <target name="nspk" depends="init">
    <!-- build adt -->
    <adt file="${nspk.dir}/term.adt" 
         factory="term" 
         package="${nspk}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${nspk}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${nspk}/**/*.java"/>
    </javac>
  </target>
  
  <target name="peano" depends="init">
    <!-- build adt -->
    <adt file="${peano.dir}/peano.adt" 
         factory="peano" 
         package="${peano}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${peano}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${peano}/**/*.java"/>
    </javac>
  </target>

  <target name="pnspk" depends="init">
    <!-- build adt -->
    <adt file="${pnspk.dir}/term.adt" 
         factory="term" 
         package="${pnspk}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${pnspk}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${pnspk}/**/*.java"/>
    </javac>
  </target>
  
  <target name="poly" depends="init">
    <!-- build adt -->
    <adt file="${poly.dir}/expression.adt" 
         factory="expression" 
         package="${poly}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${poly}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${poly}/**/*.java"/>
    </javac>
  </target>

  <target name="pqueens" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${pqueens}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${pqueens}/**/*.java"/>
    </javac>
  </target>

  <target name="rbtree" depends="init">
    <!-- build adt -->
    <adt file="${rbtree.dir}/tree.adt" 
         factory="tree" 
         package="${rbtree}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${rbtree}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${rbtree}/**/*.java"/>
    </javac>
  </target>

  <target name="set" depends="init">
    <!-- build adt -->
    <adt file="${set.dir}/jgset.adt" 
         factory="jgset" 
         package="${set}" 
         destdir="${examples.gen}"/>
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${set}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${set}/**/*.java"/>
    </javac>
  </target>

  <target name="vas" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${vas}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${vas}/**/*.java"/>
    </javac>
  </target>

  <target name="xml" depends="init">
    <!-- build tom -->
    <tom srcdir="${examples.dir}" 
         destdir="${examples.gen}" 
         options="-I ${env.TOM_HOME}/share/jtom">
      <include name="${xml}/**/*.t"/>
    </tom>
    <!-- build java source -->
    <javac srcdir="${examples.gen}" destdir="${examples.build}">
      <classpath refid="tom.classpath"/>
      <include name="${xml}/**/*.java"/>
    </javac>
  </target>
  
  
  <target name="examples" 
          description="Builds the examples (at least some)"
          depends="addressbook, apireach, boulderdash, builtin, dom,
					expression, gtree, list, nspk, peano, pnspk, poly, pqueens,
          rbtree, set, xml">
  </target>
  
  <target name="dist.examples" description="Prepare a distribution of examples" depends="prepare.examples">
    <tar tarfile="${examples.dist}/jtom-examples.tar">
      <tarfileset dir="${examples.dir}">
        <include name="README"/>
        <include name="build.xml"/>
        <include name="build.sh"/>

        <include name="${addressbook}/README"/>
        <include name="${addressbook}/*.t"/>
        <include name="${addressbook}/*.adt"/>

        <include name="${apireach}/README"/>
        <include name="${apireach}/*.t"/>
        <include name="${apireach}/*.adt"/>

        <include name="${boulderdash}/README"/>
        <include name="${boulderdash}/*.t"/>
        <include name="${boulderdash}/*.adt"/>
        <include name="${boulderdash}/*.gif"/>
        <include name="${boulderdash}/*.html"/>
        <include name="${boulderdash}/*.java"/>

        <include name="${builtin}/README"/>
        <include name="${builtin}/*.t"/>
        <include name="${builtin}/*.adt"/>

        <include name="${caml}/README"/>
        <include name="${caml}/*.t"/>
        <include name="${caml}/*.adt"/>
        <include name="${caml}/peanotype.ml"/>
        <include name="${caml}/tomExtension.ml"/>
        <include name="${caml}/tomList.ml"/>

        <include name="${dom}/README"/>
        <include name="${dom}/*.t"/>
        <include name="${dom}/*.adt"/>
        <include name="${dom}/*.xml"/>

        <include name="${expression}/README"/>
        <include name="${expression}/*.t"/>
        <include name="${expression}/*.java"/>

        <include name="${gtree}/README"/>
        <include name="${gtree}/*.t"/>
        <include name="${gtree}/*.adt"/>

        <include name="${integerc}/README"/>
        <include name="${integerc}/*.t"/>
        <include name="${integerc}/*.adt"/>

        <include name="${list}/README"/>
        <include name="${list}/*.t"/>
        <include name="${list}/*.adt"/>

        <include name="${nspk}/README"/>
        <include name="${nspk}/*.t"/>
        <include name="${nspk}/*.adt"/>

        <include name="${peano}/README"/>
        <include name="${peano}/*.t"/>

        <include name="${pnspk}/README"/>
        <include name="${pnspk}/*.t"/>
        <include name="${pnspk}/*.adt"/>

        <include name="${poly}/README"/>
        <include name="${poly}/*.t"/>
        <include name="${poly}/*.adt"/>
        <include name="${poly}/PolyCommon.java"/>
        <include name="${poly}/Poly.signature"/>

        <include name="${pqueens}/README"/>
        <include name="${pqueens}/*.t"/>
        <include name="${pqueens}/*.tom"/>

        <include name="${rbtree}/README"/>
        <include name="${rbtree}/*.t"/>
        <include name="${rbtree}/*.adt"/>

        <include name="${set}/README"/>
        <include name="${set}/*.t"/>
        <include name="${set}/*.adt"/>

        <include name="${vas}/README"/>
        <include name="${vas}/*.t"/>

        <include name="${xml}/README"/>
        <include name="${xml}/*.t"/>
        <include name="${xml}/*.adt"/>
        <include name="${xml}/*.xml"/>
        <include name="${xml}/*.html"/>

        <not>
          <present targetdir="${examples.dir}">
            <mapper type="glob" 
                    from="**/*.java" 
                    to="**/*.t"/>
          </present>
        </not>
      </tarfileset>
    </tar>
    <gzip zipfile="${examples.dist}/jtom-examples.tar.gz" 
          src="${examples.dist}/jtom-examples.tar"/>
    <delete file="${examples.dist}/jtom-examples.tar"/>
  </target>

  <target name="clean.dist" description="Mr proper" depends="clean">
    <delete dir="${examples.dist}"/>
  </target>

  <target name="clean" 
          description="Cleans everything in the project" 
          depends="clean.examples">
  </target> 

	<target name="initjunit">
		<taskdef name="tomjunit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask">
			<classpath refid="tom.classpath"/>
		</taskdef>
	</target>

	<target name="junit" description="Runs junit acceptance tests" depends="examples, initjunit">
		<tomjunit printsummary="on"
							fork="false"
							haltonfailure="false"
							failureproperty="tests.failed"
							showoutput="true">
			<classpath>
				<path refid="tom.classpath"/>
				<pathelement location="${examples.dir}"/>
			</classpath>
			<batchtest>
				<fileset dir="${examples.dir}">
					<include name="**/Test*.java"/>
				</fileset>
			</batchtest>
		</tomjunit>

		<fail if="tests.failed">
****************************************************
****************************************************
  One or more tests failed. Check the output...
****************************************************
****************************************************
		</fail>
	</target>


</project>
