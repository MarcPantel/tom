<?xml version="1.0" encoding="UTF-8"?>
<project name="Ant for Tom-examples" default="dist.examples" basedir=".">
	<description>
		This script prepare a bundle of Tom examples
	</description>

	<property environment="env" />
	<!-- some used directory location -->
	<property name="examples.dir" location="."/>
	<property name="examples.dist" location="dist"/>

	<!-- Examples to build and distribute -->
	<property name="addressbook" value="AddressBook"/>
	<property name="addressbook.dir" location="${examples.dir}/${addressbook}" />

	<property name="boulderdash" value="BoulderDash"/>
	<property name="boulderdash.dir" location="${examples.dir}/${boulderdash}" />

	<!-- Define classpath for building stable and source	-->
	<path id="tom.classpath">
		<fileset dir="${env.TOM_HOME}/lib">
			<include name="*.jar"/>
		</fileset>
	</path>
	
	<!-- tasks for building -->
	<taskdef name="adt" 
					 classname="jtom.tools.ant.ApigenTask"
					 classpathref="tom.classpath"/>
	<taskdef name="tom" 
					 classname="jtom.tools.ant.TomTask"
					 classpathref="tom.classpath"/>

	<target name="prepare.examples">
		<mkdir dir="${examples.dist}"/>
	</target>
	
	<!-- target debug to help finding properties problems -->
	<target name="debug"> 
		<echoproperties/>
	</target>

	<target name="clean.examples" description="Cleans examples directory">
		<delete>
			<fileset dir="${examples.dir}" includes="**/*.class" />
		</delete>
		<!-- deletes java files generated by tom -->
		<delete>
			<fileset dir="${examples.dir}" includes="**/*.java">
				<present targetdir="${examples.dir}">
					<mapper type="glob" from="*.java" to="*.t"/>
				</present>
			</fileset>
		</delete>
	</target>

	<target name="addressbook">
		<!-- build adt -->
		<adt file="${addressbook.dir}/data.adt" 
				 factory="data" 
				 package="adt.address" 
				 destdir="${addressbook.dir}"/>
		<!-- build tom -->
		<tom srcdir="${addressbook.dir}" 
				 destdir="${addressbook.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${addressbook.dir}" destdir="${addressbook.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>

	<target name="boulderdash">
		<!-- build adt -->
		<adt file="${boulderdash.dir}/boulder.adt" 
				 factory="boulder" 
				 package="adt.boulder" 
				 destdir="${boulderdash.dir}"/>
		<!-- build tom -->
		<tom srcdir="${boulderdash.dir}" 
				 destdir="${boulderdash.dir}" 
				 options="-I ${env.TOM_HOME}/share/jtom">
			<include name="**/*.t"/>
		</tom>
		<!-- build java source -->
		<javac srcdir="${boulderdash.dir}" destdir="${boulderdash.dir}">
			<classpath refid="tom.classpath"/>
			<include name="**/*.java"/>
		</javac>
	</target>
	
	
	<target name="build.examples" 
					description="Builds the examples (at least some)"
					depends="addressbook, boulderdash">
	</target>
	
	<target name="dist.examples" description="Prepare a
		distribution of examples" depends="prepare.examples">
		<tar tarfile="${examples.dist}/jtom-examples.tar">
			<tarfileset dir="${examples.dir}">
				<include name="${addressbook}/*.t"/>
				<include name="${addressbook}/*.adt"/>

				<include name="${boulderdash}/*.t"/>
				<include name="${boulderdash}/*.adt"/>
				<include name="${boulderdash}/*.java"/>
				<not>
					<present targetdir="${examples.dir}">
						<mapper type="glob" 
										from="${boulderdash}/*.java" 
										to="${boulderdash}/*.t"/>
					</present>
				</not>

			</tarfileset>
		</tar>
		<gzip zipfile="${examples.dist}/jtom-examples.tar.gz" src="${examples.dist}/jtom-examples.tar"/>
		<delete file="${examples.dist}/jtom-examples.tar"/>
	</target>

	<target name="clean.dist" description="Mr proper" depends="cleanall">
		<delete dir="${examples.dist}"/>
	</target>

	<target name="cleanall" 
					description="Cleans everything in the project" 
					depends="clean.examples">
	</target>	

</project>
