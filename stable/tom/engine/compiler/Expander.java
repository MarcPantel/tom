/* Generated by TOM (version 2.5): Do not edit this file *//*
 * 
 * TOM - To One Matching Compiler
 * 
 * Copyright (c) 2000-2007, INRIA
 * Nancy, France.
 * 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
 * 
 * Pierre-Etienne Moreau  e-mail: Pierre-Etienne.Moreau@loria.fr
 *
 **/

package tom.engine.compiler;

import java.util.logging.Level;
import java.util.Iterator;
import java.util.ArrayList;

import tom.engine.exception.TomRuntimeException;

import tom.engine.adt.tomsignature.*;
import tom.engine.adt.tomconstraint.types.*;
import tom.engine.adt.tomdeclaration.types.*;
import tom.engine.adt.tomexpression.types.*;
import tom.engine.adt.tominstruction.types.*;
import tom.engine.adt.tomname.types.*;
import tom.engine.adt.tomname.types.tomname.*;
import tom.engine.adt.tomoption.types.*;
import tom.engine.adt.tomsignature.types.*;
import tom.engine.adt.tomterm.types.*;
import tom.engine.adt.tomslot.types.*;
import tom.engine.adt.tomtype.types.*;

import tom.engine.TomBase;
import tom.engine.TomMessage;
import tom.engine.tools.ASTFactory;
import tom.engine.tools.TomGenericPlugin;
import tom.engine.tools.Tools;
import tom.engine.tools.SymbolTable;
import tom.engine.xml.Constants;
import tom.platform.OptionParser;
import tom.platform.adt.platformoption.types.PlatformOptionList;
import aterm.ATerm;

import tom.library.sl.*;

/**
 * The Expander plugin.
 * Perform syntax expansion and more.
 */
public class Expander extends TomGenericPlugin {

  /* Generated by TOM (version 2.5): Do not edit this file *//* Generated by TOM (version 2.5): Do not edit this file *//* Generated by TOM (version 2.5): Do not edit this file */ private static boolean tom_equal_term_String(String t1, String t2) { return  (t1.equals(t2)) ;}private static boolean tom_is_sort_String(String t) { return  t instanceof String ;}  /* Generated by TOM (version 2.5): Do not edit this file */private static boolean tom_equal_term_int(int t1, int t2) { return  (t1==t2) ;}private static boolean tom_is_sort_int(int t) { return  true ;} private static boolean tom_equal_term_Instruction(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_Instruction(Object t) { return  t instanceof tom.engine.adt.tominstruction.types.Instruction ;}private static boolean tom_equal_term_TomTypeList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomTypeList(Object t) { return  t instanceof tom.engine.adt.tomtype.types.TomTypeList ;}private static boolean tom_equal_term_TomType(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomType(Object t) { return  t instanceof tom.engine.adt.tomtype.types.TomType ;}private static boolean tom_equal_term_TomSymbol(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomSymbol(Object t) { return  t instanceof tom.engine.adt.tomsignature.types.TomSymbol ;}private static boolean tom_equal_term_Declaration(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_Declaration(Object t) { return  t instanceof tom.engine.adt.tomdeclaration.types.Declaration ;}private static boolean tom_equal_term_TomNameList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomNameList(Object t) { return  t instanceof tom.engine.adt.tomname.types.TomNameList ;}private static boolean tom_equal_term_TomName(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomName(Object t) { return  t instanceof tom.engine.adt.tomname.types.TomName ;}private static boolean tom_equal_term_Expression(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_Expression(Object t) { return  t instanceof tom.engine.adt.tomexpression.types.Expression ;}private static boolean tom_equal_term_TomList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomList(Object t) { return  t instanceof tom.engine.adt.tomterm.types.TomList ;}private static boolean tom_equal_term_TomTerm(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_TomTerm(Object t) { return  t instanceof tom.engine.adt.tomterm.types.TomTerm ;}private static boolean tom_equal_term_Option(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_Option(Object t) { return  t instanceof tom.engine.adt.tomoption.types.Option ;}private static boolean tom_equal_term_OptionList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_OptionList(Object t) { return  t instanceof tom.engine.adt.tomoption.types.OptionList ;}private static boolean tom_equal_term_Constraint(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_Constraint(Object t) { return  t instanceof tom.engine.adt.tomconstraint.types.Constraint ;}private static boolean tom_equal_term_ConstraintList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_ConstraintList(Object t) { return  t instanceof tom.engine.adt.tomconstraint.types.ConstraintList ;}private static boolean tom_equal_term_PairNameDeclList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_PairNameDeclList(Object t) { return  t instanceof tom.engine.adt.tomslot.types.PairNameDeclList ;}private static boolean tom_equal_term_SlotList(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_SlotList(Object t) { return  t instanceof tom.engine.adt.tomslot.types.SlotList ;}private static boolean tom_equal_term_Slot(Object t1, Object t2) { return  t1.equals(t2) ;}private static boolean tom_is_sort_Slot(Object t) { return  t instanceof tom.engine.adt.tomslot.types.Slot ;}private static  tom.engine.adt.tominstruction.types.Instruction  tom_make_TomTermToInstruction( tom.engine.adt.tomterm.types.TomTerm  t0) { return  tom.engine.adt.tominstruction.types.instruction.TomTermToInstruction.make(t0) ; }private static  tom.engine.adt.tominstruction.types.Instruction  tom_make_Return( tom.engine.adt.tomterm.types.TomTerm  t0) { return  tom.engine.adt.tominstruction.types.instruction.Return.make(t0) ; }private static  tom.engine.adt.tomtype.types.TomType  tom_make_TomTypeAlone( String  t0) { return  tom.engine.adt.tomtype.types.tomtype.TomTypeAlone.make(t0) ; }private static boolean tom_is_fun_sym_TypesToType( tom.engine.adt.tomtype.types.TomType  t) { return  t instanceof tom.engine.adt.tomtype.types.tomtype.TypesToType ;}private static  tom.engine.adt.tomtype.types.TomTypeList  tom_get_slot_TypesToType_Domain( tom.engine.adt.tomtype.types.TomType  t) { return  t.getDomain() ;}private static  tom.engine.adt.tomtype.types.TomType  tom_get_slot_TypesToType_Codomain( tom.engine.adt.tomtype.types.TomType  t) { return  t.getCodomain() ;}private static  tom.engine.adt.tomtype.types.TomType  tom_make_EmptyType() { return  tom.engine.adt.tomtype.types.tomtype.EmptyType.make() ; }private static boolean tom_is_fun_sym_Symbol( tom.engine.adt.tomsignature.types.TomSymbol  t) { return  t instanceof tom.engine.adt.tomsignature.types.tomsymbol.Symbol ;}private static  tom.engine.adt.tomsignature.types.TomSymbol  tom_make_Symbol( tom.engine.adt.tomname.types.TomName  t0,  tom.engine.adt.tomtype.types.TomType  t1,  tom.engine.adt.tomslot.types.PairNameDeclList  t2,  tom.engine.adt.tomoption.types.OptionList  t3) { return  tom.engine.adt.tomsignature.types.tomsymbol.Symbol.make(t0, t1, t2, t3) ; }private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_Symbol_AstName( tom.engine.adt.tomsignature.types.TomSymbol  t) { return  t.getAstName() ;}private static  tom.engine.adt.tomtype.types.TomType  tom_get_slot_Symbol_TypesToType( tom.engine.adt.tomsignature.types.TomSymbol  t) { return  t.getTypesToType() ;}private static  tom.engine.adt.tomslot.types.PairNameDeclList  tom_get_slot_Symbol_PairNameDeclList( tom.engine.adt.tomsignature.types.TomSymbol  t) { return  t.getPairNameDeclList() ;}private static  tom.engine.adt.tomoption.types.OptionList  tom_get_slot_Symbol_Option( tom.engine.adt.tomsignature.types.TomSymbol  t) { return  t.getOption() ;}private static boolean tom_is_fun_sym_IsFsymDecl( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t instanceof tom.engine.adt.tomdeclaration.types.declaration.IsFsymDecl ;}private static  tom.engine.adt.tomdeclaration.types.Declaration  tom_make_IsFsymDecl( tom.engine.adt.tomname.types.TomName  t0,  tom.engine.adt.tomterm.types.TomTerm  t1,  tom.engine.adt.tominstruction.types.Instruction  t2,  tom.engine.adt.tomoption.types.Option  t3) { return  tom.engine.adt.tomdeclaration.types.declaration.IsFsymDecl.make(t0, t1, t2, t3) ; }private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_IsFsymDecl_AstName( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getAstName() ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_get_slot_IsFsymDecl_Variable( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getVariable() ;}private static  tom.engine.adt.tominstruction.types.Instruction  tom_get_slot_IsFsymDecl_Instr( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getInstr() ;}private static  tom.engine.adt.tomoption.types.Option  tom_get_slot_IsFsymDecl_OrgTrack( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getOrgTrack() ;}private static boolean tom_is_fun_sym_GetHeadDecl( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t instanceof tom.engine.adt.tomdeclaration.types.declaration.GetHeadDecl ;}private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_GetHeadDecl_Opname( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getOpname() ;}private static  tom.engine.adt.tomtype.types.TomType  tom_get_slot_GetHeadDecl_Codomain( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getCodomain() ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_get_slot_GetHeadDecl_Variable( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getVariable() ;}private static  tom.engine.adt.tominstruction.types.Instruction  tom_get_slot_GetHeadDecl_Instr( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getInstr() ;}private static  tom.engine.adt.tomoption.types.Option  tom_get_slot_GetHeadDecl_OrgTrack( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getOrgTrack() ;}private static boolean tom_is_fun_sym_MakeEmptyList( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t instanceof tom.engine.adt.tomdeclaration.types.declaration.MakeEmptyList ;}private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_MakeEmptyList_AstName( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getAstName() ;}private static  tom.engine.adt.tominstruction.types.Instruction  tom_get_slot_MakeEmptyList_Instr( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getInstr() ;}private static  tom.engine.adt.tomoption.types.Option  tom_get_slot_MakeEmptyList_OrgTrack( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getOrgTrack() ;}private static boolean tom_is_fun_sym_MakeEmptyArray( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t instanceof tom.engine.adt.tomdeclaration.types.declaration.MakeEmptyArray ;}private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_MakeEmptyArray_AstName( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getAstName() ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_get_slot_MakeEmptyArray_VarSize( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getVarSize() ;}private static  tom.engine.adt.tominstruction.types.Instruction  tom_get_slot_MakeEmptyArray_Instr( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getInstr() ;}private static  tom.engine.adt.tomoption.types.Option  tom_get_slot_MakeEmptyArray_OrgTrack( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getOrgTrack() ;}private static boolean tom_is_fun_sym_MakeDecl( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t instanceof tom.engine.adt.tomdeclaration.types.declaration.MakeDecl ;}private static  tom.engine.adt.tomdeclaration.types.Declaration  tom_make_MakeDecl( tom.engine.adt.tomname.types.TomName  t0,  tom.engine.adt.tomtype.types.TomType  t1,  tom.engine.adt.tomterm.types.TomList  t2,  tom.engine.adt.tominstruction.types.Instruction  t3,  tom.engine.adt.tomoption.types.Option  t4) { return  tom.engine.adt.tomdeclaration.types.declaration.MakeDecl.make(t0, t1, t2, t3, t4) ; }private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_MakeDecl_AstName( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getAstName() ;}private static  tom.engine.adt.tomtype.types.TomType  tom_get_slot_MakeDecl_AstType( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getAstType() ;}private static  tom.engine.adt.tomterm.types.TomList  tom_get_slot_MakeDecl_Args( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getArgs() ;}private static  tom.engine.adt.tominstruction.types.Instruction  tom_get_slot_MakeDecl_Instr( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getInstr() ;}private static  tom.engine.adt.tomoption.types.Option  tom_get_slot_MakeDecl_OrgTrack( tom.engine.adt.tomdeclaration.types.Declaration  t) { return  t.getOrgTrack() ;}private static boolean tom_is_fun_sym_Name( tom.engine.adt.tomname.types.TomName  t) { return  t instanceof tom.engine.adt.tomname.types.tomname.Name ;}private static  tom.engine.adt.tomname.types.TomName  tom_make_Name( String  t0) { return  tom.engine.adt.tomname.types.tomname.Name.make(t0) ; }private static  String  tom_get_slot_Name_String( tom.engine.adt.tomname.types.TomName  t) { return  t.getString() ;}private static  tom.engine.adt.tomname.types.TomName  tom_make_EmptyName() { return  tom.engine.adt.tomname.types.tomname.EmptyName.make() ; }private static  tom.engine.adt.tomexpression.types.Expression  tom_make_FalseTL() { return  tom.engine.adt.tomexpression.types.expression.FalseTL.make() ; }private static boolean tom_is_fun_sym_TermAppl( tom.engine.adt.tomterm.types.TomTerm  t) { return  t instanceof tom.engine.adt.tomterm.types.tomterm.TermAppl ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_TermAppl( tom.engine.adt.tomoption.types.OptionList  t0,  tom.engine.adt.tomname.types.TomNameList  t1,  tom.engine.adt.tomterm.types.TomList  t2,  tom.engine.adt.tomconstraint.types.ConstraintList  t3) { return  tom.engine.adt.tomterm.types.tomterm.TermAppl.make(t0, t1, t2, t3) ; }private static  tom.engine.adt.tomoption.types.OptionList  tom_get_slot_TermAppl_Option( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getOption() ;}private static  tom.engine.adt.tomname.types.TomNameList  tom_get_slot_TermAppl_NameList( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getNameList() ;}private static  tom.engine.adt.tomterm.types.TomList  tom_get_slot_TermAppl_Args( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getArgs() ;}private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_get_slot_TermAppl_Constraints( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getConstraints() ;}private static boolean tom_is_fun_sym_RecordAppl( tom.engine.adt.tomterm.types.TomTerm  t) { return  t instanceof tom.engine.adt.tomterm.types.tomterm.RecordAppl ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_RecordAppl( tom.engine.adt.tomoption.types.OptionList  t0,  tom.engine.adt.tomname.types.TomNameList  t1,  tom.engine.adt.tomslot.types.SlotList  t2,  tom.engine.adt.tomconstraint.types.ConstraintList  t3) { return  tom.engine.adt.tomterm.types.tomterm.RecordAppl.make(t0, t1, t2, t3) ; }private static  tom.engine.adt.tomoption.types.OptionList  tom_get_slot_RecordAppl_Option( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getOption() ;}private static  tom.engine.adt.tomname.types.TomNameList  tom_get_slot_RecordAppl_NameList( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getNameList() ;}private static  tom.engine.adt.tomslot.types.SlotList  tom_get_slot_RecordAppl_Slots( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getSlots() ;}private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_get_slot_RecordAppl_Constraints( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getConstraints() ;}private static boolean tom_is_fun_sym_XMLAppl( tom.engine.adt.tomterm.types.TomTerm  t) { return  t instanceof tom.engine.adt.tomterm.types.tomterm.XMLAppl ;}private static  tom.engine.adt.tomoption.types.OptionList  tom_get_slot_XMLAppl_Option( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getOption() ;}private static  tom.engine.adt.tomname.types.TomNameList  tom_get_slot_XMLAppl_NameList( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getNameList() ;}private static  tom.engine.adt.tomterm.types.TomList  tom_get_slot_XMLAppl_AttrList( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getAttrList() ;}private static  tom.engine.adt.tomterm.types.TomList  tom_get_slot_XMLAppl_ChildList( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getChildList() ;}private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_get_slot_XMLAppl_Constraints( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getConstraints() ;}private static boolean tom_is_fun_sym_Variable( tom.engine.adt.tomterm.types.TomTerm  t) { return  t instanceof tom.engine.adt.tomterm.types.tomterm.Variable ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_Variable( tom.engine.adt.tomoption.types.OptionList  t0,  tom.engine.adt.tomname.types.TomName  t1,  tom.engine.adt.tomtype.types.TomType  t2,  tom.engine.adt.tomconstraint.types.ConstraintList  t3) { return  tom.engine.adt.tomterm.types.tomterm.Variable.make(t0, t1, t2, t3) ; }private static  tom.engine.adt.tomoption.types.OptionList  tom_get_slot_Variable_Option( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getOption() ;}private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_Variable_AstName( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getAstName() ;}private static  tom.engine.adt.tomtype.types.TomType  tom_get_slot_Variable_AstType( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getAstType() ;}private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_get_slot_Variable_Constraints( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getConstraints() ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_UnamedVariable( tom.engine.adt.tomoption.types.OptionList  t0,  tom.engine.adt.tomtype.types.TomType  t1,  tom.engine.adt.tomconstraint.types.ConstraintList  t2) { return  tom.engine.adt.tomterm.types.tomterm.UnamedVariable.make(t0, t1, t2) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_UnamedVariableStar( tom.engine.adt.tomoption.types.OptionList  t0,  tom.engine.adt.tomtype.types.TomType  t1,  tom.engine.adt.tomconstraint.types.ConstraintList  t2) { return  tom.engine.adt.tomterm.types.tomterm.UnamedVariableStar.make(t0, t1, t2) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_TomSymbolToTomTerm( tom.engine.adt.tomsignature.types.TomSymbol  t0) { return  tom.engine.adt.tomterm.types.tomterm.TomSymbolToTomTerm.make(t0) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_ExpressionToTomTerm( tom.engine.adt.tomexpression.types.Expression  t0) { return  tom.engine.adt.tomterm.types.tomterm.ExpressionToTomTerm.make(t0) ; }private static boolean tom_is_fun_sym_BackQuoteAppl( tom.engine.adt.tomterm.types.TomTerm  t) { return  t instanceof tom.engine.adt.tomterm.types.tomterm.BackQuoteAppl ;}private static  tom.engine.adt.tomoption.types.OptionList  tom_get_slot_BackQuoteAppl_Option( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getOption() ;}private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_BackQuoteAppl_AstName( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getAstName() ;}private static  tom.engine.adt.tomterm.types.TomList  tom_get_slot_BackQuoteAppl_Args( tom.engine.adt.tomterm.types.TomTerm  t) { return  t.getArgs() ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_FunctionCall( tom.engine.adt.tomname.types.TomName  t0,  tom.engine.adt.tomtype.types.TomType  t1,  tom.engine.adt.tomterm.types.TomList  t2) { return  tom.engine.adt.tomterm.types.tomterm.FunctionCall.make(t0, t1, t2) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_BuildConstant( tom.engine.adt.tomname.types.TomName  t0) { return  tom.engine.adt.tomterm.types.tomterm.BuildConstant.make(t0) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_make_BuildTerm( tom.engine.adt.tomname.types.TomName  t0,  tom.engine.adt.tomterm.types.TomList  t1,  String  t2) { return  tom.engine.adt.tomterm.types.tomterm.BuildTerm.make(t0, t1, t2) ; }private static boolean tom_is_fun_sym_DeclarationToOption( tom.engine.adt.tomoption.types.Option  t) { return  t instanceof tom.engine.adt.tomoption.types.option.DeclarationToOption ;}private static  tom.engine.adt.tomoption.types.Option  tom_make_DeclarationToOption( tom.engine.adt.tomdeclaration.types.Declaration  t0) { return  tom.engine.adt.tomoption.types.option.DeclarationToOption.make(t0) ; }private static  tom.engine.adt.tomdeclaration.types.Declaration  tom_get_slot_DeclarationToOption_AstDeclaration( tom.engine.adt.tomoption.types.Option  t) { return  t.getAstDeclaration() ;}private static boolean tom_is_fun_sym_OriginTracking( tom.engine.adt.tomoption.types.Option  t) { return  t instanceof tom.engine.adt.tomoption.types.option.OriginTracking ;}private static  tom.engine.adt.tomoption.types.Option  tom_make_OriginTracking( tom.engine.adt.tomname.types.TomName  t0,  int  t1,  String  t2) { return  tom.engine.adt.tomoption.types.option.OriginTracking.make(t0, t1, t2) ; }private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_OriginTracking_AstName( tom.engine.adt.tomoption.types.Option  t) { return  t.getAstName() ;}private static  int  tom_get_slot_OriginTracking_Line( tom.engine.adt.tomoption.types.Option  t) { return  t.getLine() ;}private static  String  tom_get_slot_OriginTracking_FileName( tom.engine.adt.tomoption.types.Option  t) { return  t.getFileName() ;}private static boolean tom_is_fun_sym_AssignTo( tom.engine.adt.tomconstraint.types.Constraint  t) { return  t instanceof tom.engine.adt.tomconstraint.types.constraint.AssignTo ;}private static  tom.engine.adt.tomconstraint.types.Constraint  tom_make_AssignTo( tom.engine.adt.tomterm.types.TomTerm  t0) { return  tom.engine.adt.tomconstraint.types.constraint.AssignTo.make(t0) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_get_slot_AssignTo_Variable( tom.engine.adt.tomconstraint.types.Constraint  t) { return  t.getVariable() ;}private static boolean tom_is_fun_sym_PairSlotAppl( tom.engine.adt.tomslot.types.Slot  t) { return  t instanceof tom.engine.adt.tomslot.types.slot.PairSlotAppl ;}private static  tom.engine.adt.tomslot.types.Slot  tom_make_PairSlotAppl( tom.engine.adt.tomname.types.TomName  t0,  tom.engine.adt.tomterm.types.TomTerm  t1) { return  tom.engine.adt.tomslot.types.slot.PairSlotAppl.make(t0, t1) ; }private static  tom.engine.adt.tomname.types.TomName  tom_get_slot_PairSlotAppl_SlotName( tom.engine.adt.tomslot.types.Slot  t) { return  t.getSlotName() ;}private static  tom.engine.adt.tomterm.types.TomTerm  tom_get_slot_PairSlotAppl_Appl( tom.engine.adt.tomslot.types.Slot  t) { return  t.getAppl() ;}private static boolean tom_is_fun_sym_concTomName( tom.engine.adt.tomname.types.TomNameList  t) { return  t instanceof tom.engine.adt.tomname.types.tomnamelist.ConsconcTomName || t instanceof tom.engine.adt.tomname.types.tomnamelist.EmptyconcTomName ;}private static  tom.engine.adt.tomname.types.TomNameList  tom_empty_list_concTomName() { return  tom.engine.adt.tomname.types.tomnamelist.EmptyconcTomName.make() ; }private static  tom.engine.adt.tomname.types.TomNameList  tom_cons_list_concTomName( tom.engine.adt.tomname.types.TomName  e,  tom.engine.adt.tomname.types.TomNameList  l) { return  tom.engine.adt.tomname.types.tomnamelist.ConsconcTomName.make(e,l) ; }private static  tom.engine.adt.tomname.types.TomName  tom_get_head_concTomName_TomNameList( tom.engine.adt.tomname.types.TomNameList  l) { return  l.getHeadconcTomName() ;}private static  tom.engine.adt.tomname.types.TomNameList  tom_get_tail_concTomName_TomNameList( tom.engine.adt.tomname.types.TomNameList  l) { return  l.getTailconcTomName() ;}private static boolean tom_is_empty_concTomName_TomNameList( tom.engine.adt.tomname.types.TomNameList  l) { return  l.isEmptyconcTomName() ;}   private static   tom.engine.adt.tomname.types.TomNameList  tom_append_list_concTomName( tom.engine.adt.tomname.types.TomNameList l1,  tom.engine.adt.tomname.types.TomNameList  l2) {     if(tom_is_empty_concTomName_TomNameList(l1)) {       return l2;     } else if(tom_is_empty_concTomName_TomNameList(l2)) {       return l1;     } else if(tom_is_empty_concTomName_TomNameList(tom_get_tail_concTomName_TomNameList(l1))) {       return ( tom.engine.adt.tomname.types.TomNameList )tom_cons_list_concTomName(tom_get_head_concTomName_TomNameList(l1),l2);     } else {       return ( tom.engine.adt.tomname.types.TomNameList )tom_cons_list_concTomName(tom_get_head_concTomName_TomNameList(l1),tom_append_list_concTomName(tom_get_tail_concTomName_TomNameList(l1),l2));     }   }   private static   tom.engine.adt.tomname.types.TomNameList  tom_get_slice_concTomName( tom.engine.adt.tomname.types.TomNameList  begin,  tom.engine.adt.tomname.types.TomNameList  end, tom.engine.adt.tomname.types.TomNameList  tail) {     if(tom_equal_term_TomNameList(begin,end)) {       return tail;     } else {       return ( tom.engine.adt.tomname.types.TomNameList )tom_cons_list_concTomName(tom_get_head_concTomName_TomNameList(begin),( tom.engine.adt.tomname.types.TomNameList )tom_get_slice_concTomName(tom_get_tail_concTomName_TomNameList(begin),end,tail));     }   }   private static boolean tom_is_fun_sym_concTomTerm( tom.engine.adt.tomterm.types.TomList  t) { return  t instanceof tom.engine.adt.tomterm.types.tomlist.ConsconcTomTerm || t instanceof tom.engine.adt.tomterm.types.tomlist.EmptyconcTomTerm ;}private static  tom.engine.adt.tomterm.types.TomList  tom_empty_list_concTomTerm() { return  tom.engine.adt.tomterm.types.tomlist.EmptyconcTomTerm.make() ; }private static  tom.engine.adt.tomterm.types.TomList  tom_cons_list_concTomTerm( tom.engine.adt.tomterm.types.TomTerm  e,  tom.engine.adt.tomterm.types.TomList  l) { return  tom.engine.adt.tomterm.types.tomlist.ConsconcTomTerm.make(e,l) ; }private static  tom.engine.adt.tomterm.types.TomTerm  tom_get_head_concTomTerm_TomList( tom.engine.adt.tomterm.types.TomList  l) { return  l.getHeadconcTomTerm() ;}private static  tom.engine.adt.tomterm.types.TomList  tom_get_tail_concTomTerm_TomList( tom.engine.adt.tomterm.types.TomList  l) { return  l.getTailconcTomTerm() ;}private static boolean tom_is_empty_concTomTerm_TomList( tom.engine.adt.tomterm.types.TomList  l) { return  l.isEmptyconcTomTerm() ;}   private static   tom.engine.adt.tomterm.types.TomList  tom_append_list_concTomTerm( tom.engine.adt.tomterm.types.TomList l1,  tom.engine.adt.tomterm.types.TomList  l2) {     if(tom_is_empty_concTomTerm_TomList(l1)) {       return l2;     } else if(tom_is_empty_concTomTerm_TomList(l2)) {       return l1;     } else if(tom_is_empty_concTomTerm_TomList(tom_get_tail_concTomTerm_TomList(l1))) {       return ( tom.engine.adt.tomterm.types.TomList )tom_cons_list_concTomTerm(tom_get_head_concTomTerm_TomList(l1),l2);     } else {       return ( tom.engine.adt.tomterm.types.TomList )tom_cons_list_concTomTerm(tom_get_head_concTomTerm_TomList(l1),tom_append_list_concTomTerm(tom_get_tail_concTomTerm_TomList(l1),l2));     }   }   private static   tom.engine.adt.tomterm.types.TomList  tom_get_slice_concTomTerm( tom.engine.adt.tomterm.types.TomList  begin,  tom.engine.adt.tomterm.types.TomList  end, tom.engine.adt.tomterm.types.TomList  tail) {     if(tom_equal_term_TomList(begin,end)) {       return tail;     } else {       return ( tom.engine.adt.tomterm.types.TomList )tom_cons_list_concTomTerm(tom_get_head_concTomTerm_TomList(begin),( tom.engine.adt.tomterm.types.TomList )tom_get_slice_concTomTerm(tom_get_tail_concTomTerm_TomList(begin),end,tail));     }   }   private static boolean tom_is_fun_sym_concOption( tom.engine.adt.tomoption.types.OptionList  t) { return  t instanceof tom.engine.adt.tomoption.types.optionlist.ConsconcOption || t instanceof tom.engine.adt.tomoption.types.optionlist.EmptyconcOption ;}private static  tom.engine.adt.tomoption.types.OptionList  tom_empty_list_concOption() { return  tom.engine.adt.tomoption.types.optionlist.EmptyconcOption.make() ; }private static  tom.engine.adt.tomoption.types.OptionList  tom_cons_list_concOption( tom.engine.adt.tomoption.types.Option  e,  tom.engine.adt.tomoption.types.OptionList  l) { return  tom.engine.adt.tomoption.types.optionlist.ConsconcOption.make(e,l) ; }private static  tom.engine.adt.tomoption.types.Option  tom_get_head_concOption_OptionList( tom.engine.adt.tomoption.types.OptionList  l) { return  l.getHeadconcOption() ;}private static  tom.engine.adt.tomoption.types.OptionList  tom_get_tail_concOption_OptionList( tom.engine.adt.tomoption.types.OptionList  l) { return  l.getTailconcOption() ;}private static boolean tom_is_empty_concOption_OptionList( tom.engine.adt.tomoption.types.OptionList  l) { return  l.isEmptyconcOption() ;}   private static   tom.engine.adt.tomoption.types.OptionList  tom_append_list_concOption( tom.engine.adt.tomoption.types.OptionList l1,  tom.engine.adt.tomoption.types.OptionList  l2) {     if(tom_is_empty_concOption_OptionList(l1)) {       return l2;     } else if(tom_is_empty_concOption_OptionList(l2)) {       return l1;     } else if(tom_is_empty_concOption_OptionList(tom_get_tail_concOption_OptionList(l1))) {       return ( tom.engine.adt.tomoption.types.OptionList )tom_cons_list_concOption(tom_get_head_concOption_OptionList(l1),l2);     } else {       return ( tom.engine.adt.tomoption.types.OptionList )tom_cons_list_concOption(tom_get_head_concOption_OptionList(l1),tom_append_list_concOption(tom_get_tail_concOption_OptionList(l1),l2));     }   }   private static   tom.engine.adt.tomoption.types.OptionList  tom_get_slice_concOption( tom.engine.adt.tomoption.types.OptionList  begin,  tom.engine.adt.tomoption.types.OptionList  end, tom.engine.adt.tomoption.types.OptionList  tail) {     if(tom_equal_term_OptionList(begin,end)) {       return tail;     } else {       return ( tom.engine.adt.tomoption.types.OptionList )tom_cons_list_concOption(tom_get_head_concOption_OptionList(begin),( tom.engine.adt.tomoption.types.OptionList )tom_get_slice_concOption(tom_get_tail_concOption_OptionList(begin),end,tail));     }   }   private static boolean tom_is_fun_sym_concConstraint( tom.engine.adt.tomconstraint.types.ConstraintList  t) { return  t instanceof tom.engine.adt.tomconstraint.types.constraintlist.ConsconcConstraint || t instanceof tom.engine.adt.tomconstraint.types.constraintlist.EmptyconcConstraint ;}private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_empty_list_concConstraint() { return  tom.engine.adt.tomconstraint.types.constraintlist.EmptyconcConstraint.make() ; }private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_cons_list_concConstraint( tom.engine.adt.tomconstraint.types.Constraint  e,  tom.engine.adt.tomconstraint.types.ConstraintList  l) { return  tom.engine.adt.tomconstraint.types.constraintlist.ConsconcConstraint.make(e,l) ; }private static  tom.engine.adt.tomconstraint.types.Constraint  tom_get_head_concConstraint_ConstraintList( tom.engine.adt.tomconstraint.types.ConstraintList  l) { return  l.getHeadconcConstraint() ;}private static  tom.engine.adt.tomconstraint.types.ConstraintList  tom_get_tail_concConstraint_ConstraintList( tom.engine.adt.tomconstraint.types.ConstraintList  l) { return  l.getTailconcConstraint() ;}private static boolean tom_is_empty_concConstraint_ConstraintList( tom.engine.adt.tomconstraint.types.ConstraintList  l) { return  l.isEmptyconcConstraint() ;}   private static   tom.engine.adt.tomconstraint.types.ConstraintList  tom_append_list_concConstraint( tom.engine.adt.tomconstraint.types.ConstraintList l1,  tom.engine.adt.tomconstraint.types.ConstraintList  l2) {     if(tom_is_empty_concConstraint_ConstraintList(l1)) {       return l2;     } else if(tom_is_empty_concConstraint_ConstraintList(l2)) {       return l1;     } else if(tom_is_empty_concConstraint_ConstraintList(tom_get_tail_concConstraint_ConstraintList(l1))) {       return ( tom.engine.adt.tomconstraint.types.ConstraintList )tom_cons_list_concConstraint(tom_get_head_concConstraint_ConstraintList(l1),l2);     } else {       return ( tom.engine.adt.tomconstraint.types.ConstraintList )tom_cons_list_concConstraint(tom_get_head_concConstraint_ConstraintList(l1),tom_append_list_concConstraint(tom_get_tail_concConstraint_ConstraintList(l1),l2));     }   }   private static   tom.engine.adt.tomconstraint.types.ConstraintList  tom_get_slice_concConstraint( tom.engine.adt.tomconstraint.types.ConstraintList  begin,  tom.engine.adt.tomconstraint.types.ConstraintList  end, tom.engine.adt.tomconstraint.types.ConstraintList  tail) {     if(tom_equal_term_ConstraintList(begin,end)) {       return tail;     } else {       return ( tom.engine.adt.tomconstraint.types.ConstraintList )tom_cons_list_concConstraint(tom_get_head_concConstraint_ConstraintList(begin),( tom.engine.adt.tomconstraint.types.ConstraintList )tom_get_slice_concConstraint(tom_get_tail_concConstraint_ConstraintList(begin),end,tail));     }   }   private static boolean tom_is_fun_sym_concSlot( tom.engine.adt.tomslot.types.SlotList  t) { return  t instanceof tom.engine.adt.tomslot.types.slotlist.ConsconcSlot || t instanceof tom.engine.adt.tomslot.types.slotlist.EmptyconcSlot ;}private static  tom.engine.adt.tomslot.types.SlotList  tom_empty_list_concSlot() { return  tom.engine.adt.tomslot.types.slotlist.EmptyconcSlot.make() ; }private static  tom.engine.adt.tomslot.types.SlotList  tom_cons_list_concSlot( tom.engine.adt.tomslot.types.Slot  e,  tom.engine.adt.tomslot.types.SlotList  l) { return  tom.engine.adt.tomslot.types.slotlist.ConsconcSlot.make(e,l) ; }private static  tom.engine.adt.tomslot.types.Slot  tom_get_head_concSlot_SlotList( tom.engine.adt.tomslot.types.SlotList  l) { return  l.getHeadconcSlot() ;}private static  tom.engine.adt.tomslot.types.SlotList  tom_get_tail_concSlot_SlotList( tom.engine.adt.tomslot.types.SlotList  l) { return  l.getTailconcSlot() ;}private static boolean tom_is_empty_concSlot_SlotList( tom.engine.adt.tomslot.types.SlotList  l) { return  l.isEmptyconcSlot() ;}   private static   tom.engine.adt.tomslot.types.SlotList  tom_append_list_concSlot( tom.engine.adt.tomslot.types.SlotList l1,  tom.engine.adt.tomslot.types.SlotList  l2) {     if(tom_is_empty_concSlot_SlotList(l1)) {       return l2;     } else if(tom_is_empty_concSlot_SlotList(l2)) {       return l1;     } else if(tom_is_empty_concSlot_SlotList(tom_get_tail_concSlot_SlotList(l1))) {       return ( tom.engine.adt.tomslot.types.SlotList )tom_cons_list_concSlot(tom_get_head_concSlot_SlotList(l1),l2);     } else {       return ( tom.engine.adt.tomslot.types.SlotList )tom_cons_list_concSlot(tom_get_head_concSlot_SlotList(l1),tom_append_list_concSlot(tom_get_tail_concSlot_SlotList(l1),l2));     }   }   private static   tom.engine.adt.tomslot.types.SlotList  tom_get_slice_concSlot( tom.engine.adt.tomslot.types.SlotList  begin,  tom.engine.adt.tomslot.types.SlotList  end, tom.engine.adt.tomslot.types.SlotList  tail) {     if(tom_equal_term_SlotList(begin,end)) {       return tail;     } else {       return ( tom.engine.adt.tomslot.types.SlotList )tom_cons_list_concSlot(tom_get_head_concSlot_SlotList(begin),( tom.engine.adt.tomslot.types.SlotList )tom_get_slice_concSlot(tom_get_tail_concSlot_SlotList(begin),end,tail));     }   }    /* Generated by TOM (version 2.5): Do not edit this file */private static boolean tom_equal_term_Strategy(Object t1, Object t2) { return t1.equals(t2);}private static boolean tom_is_sort_Strategy(Object t) { return  t instanceof tom.library.sl.Strategy ;}/* Generated by TOM (version 2.5): Do not edit this file */private static  tom.library.sl.Strategy  tom_make_mu( tom.library.sl.Strategy  var,  tom.library.sl.Strategy  v) { return  new tom.library.sl.Mu(var,v) ; }private static  tom.library.sl.Strategy  tom_make_MuVar( String  name) { return  new tom.library.sl.MuVar(name) ; }private static  tom.library.sl.Strategy  tom_make_Identity() { return  new tom.library.sl.Identity() ; }private static  tom.library.sl.Strategy  tom_make_All( tom.library.sl.Strategy  v) { return  new tom.library.sl.All(v) ; }private static boolean tom_is_fun_sym_ChoiceId( tom.library.sl.Strategy  t) { return  (t instanceof tom.library.sl.ChoiceId) ;}private static  tom.library.sl.Strategy  tom_empty_list_ChoiceId() { return  null ; }private static  tom.library.sl.Strategy  tom_cons_list_ChoiceId( tom.library.sl.Strategy  head,  tom.library.sl.Strategy  tail) { return  (tail==null)?head:new tom.library.sl.ChoiceId(head,tail) ; }private static  tom.library.sl.Strategy  tom_get_head_ChoiceId_Strategy( tom.library.sl.Strategy  t) { return  (tom.library.sl.Strategy)t.getChildAt(tom.library.sl.ChoiceId.FIRST) ;}private static  tom.library.sl.Strategy  tom_get_tail_ChoiceId_Strategy( tom.library.sl.Strategy  t) { return  (tom.library.sl.Strategy)t.getChildAt(tom.library.sl.ChoiceId.THEN) ;}private static boolean tom_is_empty_ChoiceId_Strategy( tom.library.sl.Strategy  t) { return  t ==null ;}   private static   tom.library.sl.Strategy  tom_append_list_ChoiceId( tom.library.sl.Strategy l1,  tom.library.sl.Strategy  l2) {     if(tom_is_empty_ChoiceId_Strategy(l1)) {       return l2;     } else if(tom_is_empty_ChoiceId_Strategy(l2)) {       return l1;     } else if(tom_is_fun_sym_ChoiceId(l1)) {       if(tom_is_empty_ChoiceId_Strategy(((tom_is_fun_sym_ChoiceId(l1))?tom_get_tail_ChoiceId_Strategy(l1):tom_empty_list_ChoiceId()))) {         return ( tom.library.sl.Strategy )tom_cons_list_ChoiceId(((tom_is_fun_sym_ChoiceId(l1))?tom_get_head_ChoiceId_Strategy(l1):l1),l2);       } else {         return ( tom.library.sl.Strategy )tom_cons_list_ChoiceId(((tom_is_fun_sym_ChoiceId(l1))?tom_get_head_ChoiceId_Strategy(l1):l1),tom_append_list_ChoiceId(((tom_is_fun_sym_ChoiceId(l1))?tom_get_tail_ChoiceId_Strategy(l1):tom_empty_list_ChoiceId()),l2));       }     } else {       return ( tom.library.sl.Strategy )tom_cons_list_ChoiceId(l1, l2);     }   }   private static   tom.library.sl.Strategy  tom_get_slice_ChoiceId( tom.library.sl.Strategy  begin,  tom.library.sl.Strategy  end, tom.library.sl.Strategy  tail) {     if(tom_equal_term_Strategy(begin,end)) {       return tail;     } else {       return ( tom.library.sl.Strategy )tom_cons_list_ChoiceId(((tom_is_fun_sym_ChoiceId(begin))?tom_get_head_ChoiceId_Strategy(begin):begin),( tom.library.sl.Strategy )tom_get_slice_ChoiceId(((tom_is_fun_sym_ChoiceId(begin))?tom_get_tail_ChoiceId_Strategy(begin):tom_empty_list_ChoiceId()),end,tail));     }   }    /* Generated by TOM (version 2.5): Do not edit this file */ /* Generated by TOM (version 2.5): Do not edit this file */   private static boolean tom_is_sort_Expander(Object t) { return 




 t instanceof Expander ;}private static  tom.library.sl.Strategy  tom_make_ChoiceTopDown( tom.library.sl.Strategy  v) { return tom_make_mu(tom_make_MuVar("x"),tom_cons_list_ChoiceId(v,tom_cons_list_ChoiceId(tom_make_All(tom_make_MuVar("x")),tom_empty_list_ChoiceId())))



 ; }


  /** some output suffixes */
  public static final String EXPANDED_SUFFIX       = ".tfix.expanded";
  public static final String EXPANDED_TABLE_SUFFIX = ".tfix.expanded.table";

  /** the declared options string */
  public static final String DECLARED_OPTIONS =
    "<options>" +
    "<boolean name='expand' altName='' description='Expander (activated by default)' value='true'/>" +
    "</options>";

  /** the kernel expander acting at very low level */
  private KernelExpander tomKernelExpander;
  /** the tomfactory for creating intermediate terms */

  /** Constructor*/
  public Expander() {
    super("Expander");
    tomKernelExpander = new KernelExpander();
  }

  /**
   * The run() method performs expansion for tom syntax, variables,...
   */
  public void run() {
    long startChrono = System.currentTimeMillis();
    boolean intermediate = getOptionBooleanValue("intermediate");
    TomTerm expandedTerm = null;
    try {
      tomKernelExpander.setSymbolTable(getStreamManager().getSymbolTable());
      TomTerm syntaxExpandedTerm = (TomTerm) tom_make_ChoiceTopDown(tom_make_expandTermApplTomSyntax(this)).visit((TomTerm)getWorkingTerm());
      updateSymbolTable();

      syntaxExpandedTerm = expandType(syntaxExpandedTerm);
      TomTerm variableExpandedTerm = expandVariable(tom_make_EmptyType(), syntaxExpandedTerm);
      /* expand each BackQuoteTerm into its compiled form */
      TomTerm backQuoteExpandedTerm = (TomTerm) tom_make_ChoiceTopDown(tom_make_expandBackQuoteAppl(this)).visit(variableExpandedTerm);
      TomTerm stringExpandedTerm = (TomTerm) tom_make_ChoiceTopDown(tom_make_expandString(this)).visit(backQuoteExpandedTerm);
      expandedTerm = (TomTerm) tom_make_ChoiceTopDown(tom_make_updateCodomain(this)).visit(stringExpandedTerm);
      setWorkingTerm(expandedTerm);
      // verbose
      getLogger().log(Level.INFO, TomMessage.tomExpandingPhase.getMessage(),
          new Integer((int)(System.currentTimeMillis()-startChrono)));
    } catch (Exception e) {
      getLogger().log( Level.SEVERE, TomMessage.exceptionMessage.getMessage(),
          new Object[]{getClass().getName(), getStreamManager().getInputFileName(), e.getMessage()} );
      e.printStackTrace();
      return;
    }
    if(intermediate) {
      Tools.generateOutput(getStreamManager().getOutputFileName()
          + EXPANDED_SUFFIX, expandedTerm);
      Tools.generateOutput(getStreamManager().getOutputFileName()
          + EXPANDED_TABLE_SUFFIX, symbolTable().toTerm());
    }
  }

  /*
   * updateSymbol is called after a first syntax expansion phase
   * this phase updates the symbolTable according to the typeTable
   * this is performed by recursively traversing each symbol
   * - backquote are expanded
   * - each TomTypeAlone is replaced by the corresponding TomType
   * - default IsFsymDecl and MakeDecl are added
   */
  public void updateSymbolTable() {
    SymbolTable symbolTable = getStreamManager().getSymbolTable();
    Iterator it = symbolTable.keySymbolIterator();
    Strategy expandStrategy = tom_make_ChoiceTopDown(tom_make_expandTermApplTomSyntax(this));

    while(it.hasNext()) {
      String tomName = (String)it.next();
      TomSymbol tomSymbol = getSymbolFromName(tomName);
      /*
       * add default IsFsymDecl and MakeDecl, unless it is a builtin type
       */
      if(!getStreamManager().getSymbolTable().isBuiltinType(TomBase.getTomType(TomBase.getSymbolCodomain(tomSymbol)))) {
        tomSymbol = addDefaultIsFsym(tomSymbol);
        tomSymbol = addDefaultMake(tomSymbol);
      }
      try {
        tomSymbol = (TomSymbol) tom_make_ChoiceTopDown(tom_make_expandTermApplTomSyntax(this)).visit(tomSymbol);
        tomSymbol = expandType(tom_make_TomSymbolToTomTerm(tomSymbol)).getAstSymbol();
        tomSymbol = expandVariable(tom_make_EmptyType(),tom_make_TomSymbolToTomTerm(tomSymbol)).getAstSymbol();
        tomSymbol = (TomSymbol) tom_make_ChoiceTopDown(tom_make_expandBackQuoteAppl(this)).visit(tomSymbol);
      } catch(tom.library.sl.VisitFailure e) {
        System.out.println("should not be there");
      }
      //System.out.println("symbol = " + tomSymbol);
      getStreamManager().getSymbolTable().putSymbol(tomName,tomSymbol);
    }
  }

  private TomSymbol addDefaultIsFsym(TomSymbol tomSymbol) {
    if (tom_is_sort_TomSymbol(tomSymbol)) {{  tom.engine.adt.tomsignature.types.TomSymbol  tomMatch145NameNumberfreshSubject_1=(( tom.engine.adt.tomsignature.types.TomSymbol )tomSymbol);if (tom_is_fun_sym_Symbol(tomMatch145NameNumberfreshSubject_1)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_0=tom_get_slot_Symbol_Option(tomMatch145NameNumberfreshSubject_1);if (tom_is_fun_sym_concOption(tomMatch145NameNumber_freshVar_0)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_1=tomMatch145NameNumber_freshVar_0;{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_begin_3=tomMatch145NameNumber_freshVar_1;{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_end_4=tomMatch145NameNumber_freshVar_1;do {{{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_2=tomMatch145NameNumber_end_4;if (!(tom_is_empty_concOption_OptionList(tomMatch145NameNumber_freshVar_2))) {if (tom_is_fun_sym_DeclarationToOption(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_2))) {{  tom.engine.adt.tomdeclaration.types.Declaration  tomMatch145NameNumber_freshVar_7=tom_get_slot_DeclarationToOption_AstDeclaration(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_2));if (tom_is_fun_sym_IsFsymDecl(tomMatch145NameNumber_freshVar_7)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_5=tom_get_tail_concOption_OptionList(tomMatch145NameNumber_freshVar_2);if ( true ) {

        return tomSymbol;
      }}}}}}}if (tom_is_empty_concOption_OptionList(tomMatch145NameNumber_end_4)) {tomMatch145NameNumber_end_4=tomMatch145NameNumber_begin_3;} else {tomMatch145NameNumber_end_4=tom_get_tail_concOption_OptionList(tomMatch145NameNumber_end_4);}}} while(!(tom_equal_term_OptionList(tomMatch145NameNumber_end_4, tomMatch145NameNumber_begin_3)));}}}}}}if (tom_is_fun_sym_Symbol(tomMatch145NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomName  tomMatch145NameNumber_freshVar_8=tom_get_slot_Symbol_AstName(tomMatch145NameNumberfreshSubject_1);{  tom.engine.adt.tomtype.types.TomType  tomMatch145NameNumber_freshVar_9=tom_get_slot_Symbol_TypesToType(tomMatch145NameNumberfreshSubject_1);{  tom.engine.adt.tomslot.types.PairNameDeclList  tomMatch145NameNumber_freshVar_10=tom_get_slot_Symbol_PairNameDeclList(tomMatch145NameNumberfreshSubject_1);{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_11=tom_get_slot_Symbol_Option(tomMatch145NameNumberfreshSubject_1);{  tom.engine.adt.tomname.types.TomName  tom_name=tomMatch145NameNumber_freshVar_8;if (tom_is_fun_sym_TypesToType(tomMatch145NameNumber_freshVar_9)) {{  tom.engine.adt.tomtype.types.TomTypeList  tomMatch145NameNumber_freshVar_12=tom_get_slot_TypesToType_Domain(tomMatch145NameNumber_freshVar_9);{  tom.engine.adt.tomtype.types.TomType  tomMatch145NameNumber_freshVar_13=tom_get_slot_TypesToType_Codomain(tomMatch145NameNumber_freshVar_9);if (tom_is_fun_sym_concOption(tomMatch145NameNumber_freshVar_11)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_14=tomMatch145NameNumber_freshVar_11;{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_begin_16=tomMatch145NameNumber_freshVar_14;{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_end_17=tomMatch145NameNumber_freshVar_14;do {{{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_15=tomMatch145NameNumber_end_17;if (!(tom_is_empty_concOption_OptionList(tomMatch145NameNumber_freshVar_15))) {if (tom_is_fun_sym_OriginTracking(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_15))) {{  tom.engine.adt.tomname.types.TomName  tomMatch145NameNumber_freshVar_60=tom_get_slot_OriginTracking_AstName(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_15));{  int  tomMatch145NameNumber_freshVar_61=tom_get_slot_OriginTracking_Line(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_15));{  String  tomMatch145NameNumber_freshVar_62=tom_get_slot_OriginTracking_FileName(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_15));{  int  tom_line=tomMatch145NameNumber_freshVar_61;{  String  tom_file=tomMatch145NameNumber_freshVar_62;{  tom.engine.adt.tomoption.types.OptionList  tomMatch145NameNumber_freshVar_18=tom_get_tail_concOption_OptionList(tomMatch145NameNumber_freshVar_15);if ( true ) {

        Declaration isfsym = tom_make_IsFsymDecl(tom_name,tom_make_Variable(tom_cons_list_concOption(tom_make_OriginTracking(tom_make_Name("t"),tom_line,tom_file),tom_empty_list_concOption()),tom_make_Name("t"),tomMatch145NameNumber_freshVar_13,tom_empty_list_concConstraint()),tom_make_Return(tom_make_ExpressionToTomTerm(tom_make_FalseTL())),tom_make_OriginTracking(tom_make_Name("is_fsym"),tom_line,tom_file));
        return tom_make_Symbol(tom_name,tomMatch145NameNumber_freshVar_9,tomMatch145NameNumber_freshVar_10,tom_append_list_concOption(tom_get_slice_concOption(tomMatch145NameNumber_begin_16,tomMatch145NameNumber_end_17,tom_empty_list_concOption()),tom_cons_list_concOption(tom_get_head_concOption_OptionList(tomMatch145NameNumber_freshVar_15),tom_cons_list_concOption(tom_make_DeclarationToOption(isfsym),tom_append_list_concOption(tomMatch145NameNumber_freshVar_18,tom_empty_list_concOption())))));
      }}}}}}}}}}if (tom_is_empty_concOption_OptionList(tomMatch145NameNumber_end_17)) {tomMatch145NameNumber_end_17=tomMatch145NameNumber_begin_16;} else {tomMatch145NameNumber_end_17=tom_get_tail_concOption_OptionList(tomMatch145NameNumber_end_17);}}} while(!(tom_equal_term_OptionList(tomMatch145NameNumber_end_17, tomMatch145NameNumber_begin_16)));}}}}}}}}}}}}}}}

    return tomSymbol;
  }

  private TomSymbol addDefaultMake(TomSymbol tomSymbol) {
    if (tom_is_sort_TomSymbol(tomSymbol)) {{  tom.engine.adt.tomsignature.types.TomSymbol  tomMatch146NameNumberfreshSubject_1=(( tom.engine.adt.tomsignature.types.TomSymbol )tomSymbol);if (tom_is_fun_sym_Symbol(tomMatch146NameNumberfreshSubject_1)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_0=tom_get_slot_Symbol_Option(tomMatch146NameNumberfreshSubject_1);if (tom_is_fun_sym_concOption(tomMatch146NameNumber_freshVar_0)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_1=tomMatch146NameNumber_freshVar_0;{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_begin_3=tomMatch146NameNumber_freshVar_1;{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_end_4=tomMatch146NameNumber_freshVar_1;do {{{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_2=tomMatch146NameNumber_end_4;if (!(tom_is_empty_concOption_OptionList(tomMatch146NameNumber_freshVar_2))) {if (tom_is_fun_sym_DeclarationToOption(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_2))) {{  tom.engine.adt.tomdeclaration.types.Declaration  tomMatch146NameNumber_freshVar_7=tom_get_slot_DeclarationToOption_AstDeclaration(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_2));{ boolean tomMatch146NameNumber_freshVar_8= false ;if (tom_is_fun_sym_MakeDecl(tomMatch146NameNumber_freshVar_7)) {tomMatch146NameNumber_freshVar_8= true ;} else {if (tom_is_fun_sym_MakeEmptyList(tomMatch146NameNumber_freshVar_7)) {tomMatch146NameNumber_freshVar_8= true ;} else {if (tom_is_fun_sym_MakeEmptyArray(tomMatch146NameNumber_freshVar_7)) {tomMatch146NameNumber_freshVar_8= true ;}}}if ((tomMatch146NameNumber_freshVar_8 ==  true )) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_5=tom_get_tail_concOption_OptionList(tomMatch146NameNumber_freshVar_2);if ( true ) {

        return tomSymbol;
      }}}}}}}}if (tom_is_empty_concOption_OptionList(tomMatch146NameNumber_end_4)) {tomMatch146NameNumber_end_4=tomMatch146NameNumber_begin_3;} else {tomMatch146NameNumber_end_4=tom_get_tail_concOption_OptionList(tomMatch146NameNumber_end_4);}}} while(!(tom_equal_term_OptionList(tomMatch146NameNumber_end_4, tomMatch146NameNumber_begin_3)));}}}}}}if (tom_is_fun_sym_Symbol(tomMatch146NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomName  tomMatch146NameNumber_freshVar_9=tom_get_slot_Symbol_AstName(tomMatch146NameNumberfreshSubject_1);{  tom.engine.adt.tomtype.types.TomType  tomMatch146NameNumber_freshVar_10=tom_get_slot_Symbol_TypesToType(tomMatch146NameNumberfreshSubject_1);{  tom.engine.adt.tomslot.types.PairNameDeclList  tomMatch146NameNumber_freshVar_11=tom_get_slot_Symbol_PairNameDeclList(tomMatch146NameNumberfreshSubject_1);{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_12=tom_get_slot_Symbol_Option(tomMatch146NameNumberfreshSubject_1);{  tom.engine.adt.tomname.types.TomName  tom_name=tomMatch146NameNumber_freshVar_9;if (tom_is_fun_sym_TypesToType(tomMatch146NameNumber_freshVar_10)) {{  tom.engine.adt.tomtype.types.TomTypeList  tomMatch146NameNumber_freshVar_13=tom_get_slot_TypesToType_Domain(tomMatch146NameNumber_freshVar_10);{  tom.engine.adt.tomtype.types.TomType  tomMatch146NameNumber_freshVar_14=tom_get_slot_TypesToType_Codomain(tomMatch146NameNumber_freshVar_10);{  tom.engine.adt.tomtype.types.TomType  tom_codomain=tomMatch146NameNumber_freshVar_14;if (tom_is_fun_sym_concOption(tomMatch146NameNumber_freshVar_12)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_15=tomMatch146NameNumber_freshVar_12;{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_begin_17=tomMatch146NameNumber_freshVar_15;{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_end_18=tomMatch146NameNumber_freshVar_15;do {{{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_16=tomMatch146NameNumber_end_18;if (!(tom_is_empty_concOption_OptionList(tomMatch146NameNumber_freshVar_16))) {if (tom_is_fun_sym_OriginTracking(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_16))) {{  tom.engine.adt.tomname.types.TomName  tomMatch146NameNumber_freshVar_61=tom_get_slot_OriginTracking_AstName(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_16));{  int  tomMatch146NameNumber_freshVar_62=tom_get_slot_OriginTracking_Line(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_16));{  String  tomMatch146NameNumber_freshVar_63=tom_get_slot_OriginTracking_FileName(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_16));{  tom.engine.adt.tomoption.types.OptionList  tomMatch146NameNumber_freshVar_19=tom_get_tail_concOption_OptionList(tomMatch146NameNumber_freshVar_16);if ( true ) {

        //build variables for make
        TomTypeList typesList = tomMatch146NameNumber_freshVar_13;
        TomList argsAST = tom_empty_list_concTomTerm();
        int index = 0;
        while(!typesList.isEmptyconcTomType()) {
          TomType subtermType = typesList.getHeadconcTomType();
          TomTerm variable = tom_make_Variable(tom_empty_list_concOption(),tom_make_Name("t"+index),subtermType,tom_empty_list_concConstraint());
          argsAST = tom_append_list_concTomTerm(argsAST,tom_cons_list_concTomTerm(variable,tom_empty_list_concTomTerm()));
          typesList = typesList.getTailconcTomType();
          index++;
        }
        TomTerm functionCall = tom_make_FunctionCall(tom_name,tom_codomain,argsAST);
        Declaration make = tom_make_MakeDecl(tom_name,tom_codomain,argsAST,tom_make_TomTermToInstruction(functionCall),tom_make_OriginTracking(tom_make_Name("make"),tomMatch146NameNumber_freshVar_62,tomMatch146NameNumber_freshVar_63))
;
        return tom_make_Symbol(tom_name,tomMatch146NameNumber_freshVar_10,tomMatch146NameNumber_freshVar_11,tom_append_list_concOption(tom_get_slice_concOption(tomMatch146NameNumber_begin_17,tomMatch146NameNumber_end_18,tom_empty_list_concOption()),tom_cons_list_concOption(tom_get_head_concOption_OptionList(tomMatch146NameNumber_freshVar_16),tom_cons_list_concOption(tom_make_DeclarationToOption(make),tom_append_list_concOption(tomMatch146NameNumber_freshVar_19,tom_empty_list_concOption())))));
      }}}}}}}}if (tom_is_empty_concOption_OptionList(tomMatch146NameNumber_end_18)) {tomMatch146NameNumber_end_18=tomMatch146NameNumber_begin_17;} else {tomMatch146NameNumber_end_18=tom_get_tail_concOption_OptionList(tomMatch146NameNumber_end_18);}}} while(!(tom_equal_term_OptionList(tomMatch146NameNumber_end_18, tomMatch146NameNumber_begin_17)));}}}}}}}}}}}}}}}}

    return tomSymbol;
  }
  /**
   * inherited from OptionOwner interface (plugin)
   */
  public PlatformOptionList getDeclaredOptionList() {
    return OptionParser.xmlToOptionList(Expander.DECLARED_OPTIONS);
  }

  private TomTerm expandVariable(TomType contextType, TomTerm subject) {
    return (TomTerm)tomKernelExpander.expandVariable(contextType,subject);
  }
  private TomTerm expandType(TomTerm subject) {
    return (TomTerm)tomKernelExpander.expandType(subject);
  }

  /*
   * The 'expandTermApplTomSyntax' phase replaces:
   * - each 'TermAppl' by its expanded record form:
   *    placeholders are not removed
   *    slotName are attached to arguments
   */
  private static class expandTermApplTomSyntax extends  tom.engine.adt.tomsignature.TomSignatureBasicStrategy  {private  Expander  expander; public expandTermApplTomSyntax( Expander  expander) { super(tom_make_Identity());this.expander=expander;}public  Expander  getexpander() { return expander;}public tom.library.sl.Visitable[] getChildren() {tom.library.sl.Visitable[] stratChilds = new tom.library.sl.Visitable[getChildCount()];for (int i = 0; i < getChildCount(); i++) {stratChilds[i]=getChildAt(i);}return stratChilds;}public tom.library.sl.Visitable setChildren(tom.library.sl.Visitable[] children) {for (int i = 0; i < getChildCount(); i++) {setChildAt(i,children[i]);}return this;}public int getChildCount() { return 1; }public tom.library.sl.Visitable getChildAt(int index) {switch (index) {case 0: return super.getChildAt(0);default: throw new IndexOutOfBoundsException();}}public tom.library.sl.Visitable setChildAt(int index, tom.library.sl.Visitable child) {switch (index) {case 0: return super.setChildAt(0, child);default: throw new IndexOutOfBoundsException();}}public  tom.engine.adt.tomterm.types.TomTerm  visit_TomTerm( tom.engine.adt.tomterm.types.TomTerm  tom__arg) throws tom.library.sl.VisitFailure {if (tom_is_sort_TomTerm(tom__arg)) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch147NameNumberfreshSubject_1=(( tom.engine.adt.tomterm.types.TomTerm )tom__arg);if (tom_is_fun_sym_TermAppl(tomMatch147NameNumberfreshSubject_1)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch147NameNumber_freshVar_0=tom_get_slot_TermAppl_Option(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomname.types.TomNameList  tomMatch147NameNumber_freshVar_1=tom_get_slot_TermAppl_NameList(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomterm.types.TomList  tomMatch147NameNumber_freshVar_2=tom_get_slot_TermAppl_Args(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomconstraint.types.ConstraintList  tomMatch147NameNumber_freshVar_3=tom_get_slot_TermAppl_Constraints(tomMatch147NameNumberfreshSubject_1);if ( true ) {








        return expander.expandTermAppl(tomMatch147NameNumber_freshVar_0,tomMatch147NameNumber_freshVar_1,tomMatch147NameNumber_freshVar_2,tomMatch147NameNumber_freshVar_3);
      }}}}}}if (tom_is_fun_sym_XMLAppl(tomMatch147NameNumberfreshSubject_1)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch147NameNumber_freshVar_4=tom_get_slot_XMLAppl_Option(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomname.types.TomNameList  tomMatch147NameNumber_freshVar_5=tom_get_slot_XMLAppl_NameList(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomterm.types.TomList  tomMatch147NameNumber_freshVar_6=tom_get_slot_XMLAppl_AttrList(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomterm.types.TomList  tomMatch147NameNumber_freshVar_7=tom_get_slot_XMLAppl_ChildList(tomMatch147NameNumberfreshSubject_1);{  tom.engine.adt.tomconstraint.types.ConstraintList  tomMatch147NameNumber_freshVar_8=tom_get_slot_XMLAppl_Constraints(tomMatch147NameNumberfreshSubject_1);if ( true ) {


        //System.out.println("expandXML in:\n" + subject);
        return expander.expandXMLAppl(tomMatch147NameNumber_freshVar_4, tomMatch147NameNumber_freshVar_5, tomMatch147NameNumber_freshVar_6, tomMatch147NameNumber_freshVar_7,tomMatch147NameNumber_freshVar_8);
      }}}}}}}}}return super.visit_TomTerm(tom__arg); }}private static  tom.library.sl.Strategy  tom_make_expandTermApplTomSyntax( Expander  t0) { return new expandTermApplTomSyntax(t0); }



    /*
     * this post-processing phase replaces untyped (universalType) codomain
     * by their precise type (according to the symbolTable)
     */
    private static class updateCodomain extends  tom.engine.adt.tomsignature.TomSignatureBasicStrategy  {private  Expander  expander; public updateCodomain( Expander  expander) { super(tom_make_Identity());this.expander=expander;}public  Expander  getexpander() { return expander;}public tom.library.sl.Visitable[] getChildren() {tom.library.sl.Visitable[] stratChilds = new tom.library.sl.Visitable[getChildCount()];for (int i = 0; i < getChildCount(); i++) {stratChilds[i]=getChildAt(i);}return stratChilds;}public tom.library.sl.Visitable setChildren(tom.library.sl.Visitable[] children) {for (int i = 0; i < getChildCount(); i++) {setChildAt(i,children[i]);}return this;}public int getChildCount() { return 1; }public tom.library.sl.Visitable getChildAt(int index) {switch (index) {case 0: return super.getChildAt(0);default: throw new IndexOutOfBoundsException();}}public tom.library.sl.Visitable setChildAt(int index, tom.library.sl.Visitable child) {switch (index) {case 0: return super.setChildAt(0, child);default: throw new IndexOutOfBoundsException();}}public  tom.engine.adt.tomdeclaration.types.Declaration  visit_Declaration( tom.engine.adt.tomdeclaration.types.Declaration  tom__arg) throws tom.library.sl.VisitFailure {if (tom_is_sort_Declaration(tom__arg)) {{  tom.engine.adt.tomdeclaration.types.Declaration  tomMatch148NameNumberfreshSubject_1=(( tom.engine.adt.tomdeclaration.types.Declaration )tom__arg);if (tom_is_fun_sym_GetHeadDecl(tomMatch148NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomName  tomMatch148NameNumber_freshVar_0=tom_get_slot_GetHeadDecl_Opname(tomMatch148NameNumberfreshSubject_1);if (tom_is_fun_sym_Name(tomMatch148NameNumber_freshVar_0)) {{  String  tomMatch148NameNumber_freshVar_1=tom_get_slot_Name_String(tomMatch148NameNumber_freshVar_0);if ( true ) {


          TomSymbol tomSymbol = expander.getSymbolFromName(tomMatch148NameNumber_freshVar_1);
          TomTypeList codomain = TomBase.getSymbolDomain(tomSymbol);
          if(codomain.length()==1) {
            Declaration t = (Declaration)tomMatch148NameNumberfreshSubject_1;
            t = t.setCodomain(codomain.getHeadconcTomType());
            return t;
          } else {
            throw new TomRuntimeException("updateCodomain: bad codomain: " + codomain);
          }
        }}}}}if (tom_is_fun_sym_GetHeadDecl(tomMatch148NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch148NameNumber_freshVar_2=tom_get_slot_GetHeadDecl_Variable(tomMatch148NameNumberfreshSubject_1);if (tom_is_fun_sym_Variable(tomMatch148NameNumber_freshVar_2)) {{  tom.engine.adt.tomtype.types.TomType  tomMatch148NameNumber_freshVar_3=tom_get_slot_Variable_AstType(tomMatch148NameNumber_freshVar_2);if ( true ) {


          TomSymbol tomSymbol = expander.getSymbolFromType(tomMatch148NameNumber_freshVar_3);
          if(tomSymbol != null) {
            TomTypeList codomain = TomBase.getSymbolDomain(tomSymbol);

            if(codomain.length()==1) {
              Declaration t = (Declaration)tomMatch148NameNumberfreshSubject_1;
              t = t.setCodomain(codomain.getHeadconcTomType());
              return t;
            } else {
              throw new TomRuntimeException("updateCodomain: bad codomain: " + codomain);
            }
          }
        }}}}}}}return super.visit_Declaration(tom__arg); }}private static  tom.library.sl.Strategy  tom_make_updateCodomain( Expander  t0) { return new updateCodomain(t0); }



    /*
     * replace 'abc' by conc('a','b','c')
     */
    private static class expandString extends  tom.engine.adt.tomsignature.TomSignatureBasicStrategy  {private  Expander  expander; public expandString( Expander  expander) { super(tom_make_Identity());this.expander=expander;}public  Expander  getexpander() { return expander;}public tom.library.sl.Visitable[] getChildren() {tom.library.sl.Visitable[] stratChilds = new tom.library.sl.Visitable[getChildCount()];for (int i = 0; i < getChildCount(); i++) {stratChilds[i]=getChildAt(i);}return stratChilds;}public tom.library.sl.Visitable setChildren(tom.library.sl.Visitable[] children) {for (int i = 0; i < getChildCount(); i++) {setChildAt(i,children[i]);}return this;}public int getChildCount() { return 1; }public tom.library.sl.Visitable getChildAt(int index) {switch (index) {case 0: return super.getChildAt(0);default: throw new IndexOutOfBoundsException();}}public tom.library.sl.Visitable setChildAt(int index, tom.library.sl.Visitable child) {switch (index) {case 0: return super.setChildAt(0, child);default: throw new IndexOutOfBoundsException();}}public  tom.engine.adt.tomterm.types.TomTerm  visit_TomTerm( tom.engine.adt.tomterm.types.TomTerm  tom__arg) throws tom.library.sl.VisitFailure {if (tom_is_sort_TomTerm(tom__arg)) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch149NameNumberfreshSubject_1=(( tom.engine.adt.tomterm.types.TomTerm )tom__arg);if (tom_is_fun_sym_RecordAppl(tomMatch149NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch149NameNumber_freshVar_0=tom_get_slot_RecordAppl_NameList(tomMatch149NameNumberfreshSubject_1);{  tom.engine.adt.tomslot.types.SlotList  tomMatch149NameNumber_freshVar_1=tom_get_slot_RecordAppl_Slots(tomMatch149NameNumberfreshSubject_1);if (tom_is_fun_sym_concTomName(tomMatch149NameNumber_freshVar_0)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch149NameNumber_freshVar_2=tomMatch149NameNumber_freshVar_0;if (!(tom_is_empty_concTomName_TomNameList(tomMatch149NameNumber_freshVar_2))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch149NameNumber_freshVar_2))) {{  String  tomMatch149NameNumber_freshVar_5=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch149NameNumber_freshVar_2));{  tom.engine.adt.tomname.types.TomNameList  tomMatch149NameNumber_freshVar_3=tom_get_tail_concTomName_TomNameList(tomMatch149NameNumber_freshVar_2);{  tom.engine.adt.tomslot.types.SlotList  tom_args=tomMatch149NameNumber_freshVar_1;if ( true ) {


          TomSymbol tomSymbol = expander.getSymbolFromName(tomMatch149NameNumber_freshVar_5);
          //System.out.println("appl = " + subject);
          if(tomSymbol != null) {
            if(TomBase.isListOperator(tomSymbol) || TomBase.isArrayOperator(tomSymbol)) {
              //System.out.println("appl = " + subject);
              SlotList newArgs = expander.expandChar(tomSymbol,tom_args);
              if(newArgs!=tom_args) {
                return tomMatch149NameNumberfreshSubject_1.setSlots(newArgs);
              }
            }
          }
        }}}}}}}}}}}}}return super.visit_TomTerm(tom__arg); }}private static  tom.library.sl.Strategy  tom_make_expandString( Expander  t0) { return new expandString(t0); }



    /*
     * detect ill-formed char: 'abc'
     * and expand it into a list of char: 'a','b','c'
     */
    private SlotList expandChar(TomSymbol tomSymbol,SlotList args) {
      if(args.isEmptyconcSlot()) {
        return args;
      } else {
        Slot head = args.getHeadconcSlot();
        SlotList tail = expandChar(tomSymbol,args.getTailconcSlot());
        if (tom_is_sort_Slot(head)) {{  tom.engine.adt.tomslot.types.Slot  tomMatch151NameNumberfreshSubject_1=(( tom.engine.adt.tomslot.types.Slot )head);if (tom_is_fun_sym_PairSlotAppl(tomMatch151NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomName  tomMatch151NameNumber_freshVar_0=tom_get_slot_PairSlotAppl_SlotName(tomMatch151NameNumberfreshSubject_1);{  tom.engine.adt.tomterm.types.TomTerm  tomMatch151NameNumber_freshVar_1=tom_get_slot_PairSlotAppl_Appl(tomMatch151NameNumberfreshSubject_1);{  tom.engine.adt.tomname.types.TomName  tom_slotName=tomMatch151NameNumber_freshVar_0;if (tom_is_fun_sym_RecordAppl(tomMatch151NameNumber_freshVar_1)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch151NameNumber_freshVar_2=tom_get_slot_RecordAppl_Option(tomMatch151NameNumber_freshVar_1);{  tom.engine.adt.tomname.types.TomNameList  tomMatch151NameNumber_freshVar_3=tom_get_slot_RecordAppl_NameList(tomMatch151NameNumber_freshVar_1);{  tom.engine.adt.tomslot.types.SlotList  tomMatch151NameNumber_freshVar_4=tom_get_slot_RecordAppl_Slots(tomMatch151NameNumber_freshVar_1);{  tom.engine.adt.tomconstraint.types.ConstraintList  tomMatch151NameNumber_freshVar_5=tom_get_slot_RecordAppl_Constraints(tomMatch151NameNumber_freshVar_1);if (tom_is_fun_sym_concTomName(tomMatch151NameNumber_freshVar_3)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch151NameNumber_freshVar_6=tomMatch151NameNumber_freshVar_3;if (!(tom_is_empty_concTomName_TomNameList(tomMatch151NameNumber_freshVar_6))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch151NameNumber_freshVar_6))) {{  String  tomMatch151NameNumber_freshVar_9=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch151NameNumber_freshVar_6));{  String  tom_tomName=tomMatch151NameNumber_freshVar_9;{  tom.engine.adt.tomname.types.TomNameList  tomMatch151NameNumber_freshVar_7=tom_get_tail_concTomName_TomNameList(tomMatch151NameNumber_freshVar_6);if (tom_is_empty_concTomName_TomNameList(tomMatch151NameNumber_freshVar_7)) {if (tom_is_fun_sym_concSlot(tomMatch151NameNumber_freshVar_4)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch151NameNumber_freshVar_8=tomMatch151NameNumber_freshVar_4;if (tom_is_empty_concSlot_SlotList(tomMatch151NameNumber_freshVar_8)) {{  tom.engine.adt.tomconstraint.types.ConstraintList  tom_constraintList=tomMatch151NameNumber_freshVar_5;if ( true ) {

            /*
             * ensure that the argument contains at least 1 character and 2 single quotes
             */
            TomSymbol stringSymbol = getSymbolFromName(tom_tomName);
            TomType termType = stringSymbol.getTypesToType().getCodomain();
            String type = termType.getTomType().getString();
            if(symbolTable().isCharType(type) && tom_tomName.length()>3) {
              if(tom_tomName.charAt(0)=='\'' && tom_tomName.charAt(tom_tomName.length()-1)=='\'') {
                SlotList newArgs = tom_empty_list_concSlot();
                //System.out.println("bingo -> " + stringSymbol);
                for(int i=tom_tomName.length()-2 ; i>0 ;  i--) {
                  char c = tom_tomName.charAt(i);
                  String newName = "'" + c + "'";
                  TomSymbol newSymbol = stringSymbol.setAstName(tom_make_Name(newName));
                  symbolTable().putSymbol(newName,newSymbol);

                  Slot newHead = tom_make_PairSlotAppl(tom_slotName,tom_make_RecordAppl(tomMatch151NameNumber_freshVar_2,tom_cons_list_concTomName(tom_make_Name(newName),tom_empty_list_concTomName()),tom_empty_list_concSlot(),tom_empty_list_concConstraint()));
                  newArgs = tom_cons_list_concSlot(newHead,tom_append_list_concSlot(newArgs,tom_empty_list_concSlot()));
                  //System.out.println("newHead = " + newHead);
                  //System.out.println("newSymb = " + getSymbolFromName(newName));
                }
                ConstraintList newConstraintList = tom_empty_list_concConstraint();
                if (tom_is_sort_ConstraintList(tom_constraintList)) {{  tom.engine.adt.tomconstraint.types.ConstraintList  tomMatch150NameNumberfreshSubject_1=(( tom.engine.adt.tomconstraint.types.ConstraintList )tom_constraintList);if (tom_is_fun_sym_concConstraint(tomMatch150NameNumberfreshSubject_1)) {{  tom.engine.adt.tomconstraint.types.ConstraintList  tomMatch150NameNumber_freshVar_0=tomMatch150NameNumberfreshSubject_1;if (!(tom_is_empty_concConstraint_ConstraintList(tomMatch150NameNumber_freshVar_0))) {if (tom_is_fun_sym_AssignTo(tom_get_head_concConstraint_ConstraintList(tomMatch150NameNumber_freshVar_0))) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch150NameNumber_freshVar_2=tom_get_slot_AssignTo_Variable(tom_get_head_concConstraint_ConstraintList(tomMatch150NameNumber_freshVar_0));if (tom_is_fun_sym_Variable(tomMatch150NameNumber_freshVar_2)) {{  tom.engine.adt.tomtype.types.TomType  tomMatch150NameNumber_freshVar_3=tom_get_slot_Variable_AstType(tomMatch150NameNumber_freshVar_2);{  tom.engine.adt.tomconstraint.types.ConstraintList  tomMatch150NameNumber_freshVar_1=tom_get_tail_concConstraint_ConstraintList(tomMatch150NameNumber_freshVar_0);if (tom_is_empty_concConstraint_ConstraintList(tomMatch150NameNumber_freshVar_1)) {if ( true ) {

                    if(symbolTable().isCharType(TomBase.getTomType(tomMatch150NameNumber_freshVar_3))) {
                      newConstraintList = tom_cons_list_concConstraint(tom_make_AssignTo(tomMatch150NameNumber_freshVar_2.setAstType(symbolTable().getStringType())),tom_empty_list_concConstraint());
                    }
                  }}}}}}}}}}}}


                TomTerm newSublist = tom_make_RecordAppl(tom_empty_list_concOption(),tom_cons_list_concTomName(tomSymbol.getAstName(),tom_empty_list_concTomName()),newArgs,newConstraintList);
                Slot newSlot = tom_make_PairSlotAppl(tom_slotName,newSublist);
                return tom_cons_list_concSlot(newSlot,tom_append_list_concSlot(tail,tom_empty_list_concSlot()));
              } else {
                throw new TomRuntimeException("expandChar: strange char: " + tom_tomName);
              }
            }
          }}}}}}}}}}}}}}}}}}}}}}}}

        return tom_cons_list_concSlot(head,tom_append_list_concSlot(tail,tom_empty_list_concSlot()));
      }
    }

    /*
     * replaces 'TermAppl' by its 'RecordAppl' form
     * when no slotName exits, the position becomes the slotName
     */
    protected TomTerm expandTermAppl(OptionList option, TomNameList nameList, TomList args, ConstraintList constraints) {
      TomName headName = nameList.getHeadconcTomName();
      if(headName instanceof AntiName) {
        headName = ((AntiName)headName).getName();
      }
      String opName = headName.getString();
      TomSymbol tomSymbol = getSymbolFromName(opName);


      //System.out.println("expandTermAppl: " + tomSymbol);
      //System.out.println("  nameList = " + nameList);

      if(tomSymbol==null && args.isEmptyconcTomTerm()) {
        return tom_make_RecordAppl(option,nameList,tom_empty_list_concSlot(),constraints);
      }

      /*
         if(tomSymbol==null && !args.isEmpty() && !opName.equals("")) {
         System.out.println("expandTermAppl: " + tomSymbol);
         System.out.println("  opName = " + opName);
         System.out.println("  args = " + args);
         throw new TomRuntimeException("expandTermAppl: unknown symbol");
         }
       */

      SlotList slotList = tom_empty_list_concSlot();
      Strategy expandStrategy = tom_make_ChoiceTopDown(tom_make_expandTermApplTomSyntax(this));
      if(opName.equals("") || tomSymbol==null || TomBase.isListOperator(tomSymbol) || TomBase.isArrayOperator(tomSymbol)) {
        while(!args.isEmptyconcTomTerm()) {
          try {
            TomTerm subterm = (TomTerm) expandStrategy.visit(args.getHeadconcTomTerm());
            TomName slotName = tom_make_EmptyName();
            /*
             * we cannot optimize when subterm.isUnamedVariable
             * since it can be constrained
             */	  
            slotList = tom_append_list_concSlot(slotList,tom_cons_list_concSlot(tom_make_PairSlotAppl(slotName,subterm),tom_empty_list_concSlot()));
            args = args.getTailconcTomTerm();
          } catch(tom.library.sl.VisitFailure e) {}
        }
      } else {
        PairNameDeclList pairNameDeclList = tomSymbol.getPairNameDeclList();
        while(!args.isEmptyconcTomTerm()) {
          try{
            TomTerm subterm = (TomTerm) expandStrategy.visit(args.getHeadconcTomTerm());
            TomName slotName = pairNameDeclList.getHeadconcPairNameDecl().getSlotName();
            /*
             * we cannot optimize when subterm.isUnamedVariable
             * since it can be constrained
             */	  
            slotList = tom_append_list_concSlot(slotList,tom_cons_list_concSlot(tom_make_PairSlotAppl(slotName,subterm),tom_empty_list_concSlot()));
            args = args.getTailconcTomTerm();
            pairNameDeclList = pairNameDeclList.getTailconcPairNameDecl();
          }catch(tom.library.sl.VisitFailure e){}
        }
      }

      return tom_make_RecordAppl(option,nameList,slotList,constraints);
    }

    private static class expandBackQuoteAppl extends  tom.engine.adt.tomsignature.TomSignatureBasicStrategy  {private  Expander  expander; public expandBackQuoteAppl( Expander  expander) { super(tom_make_Identity());this.expander=expander;}public  Expander  getexpander() { return expander;}public tom.library.sl.Visitable[] getChildren() {tom.library.sl.Visitable[] stratChilds = new tom.library.sl.Visitable[getChildCount()];for (int i = 0; i < getChildCount(); i++) {stratChilds[i]=getChildAt(i);}return stratChilds;}public tom.library.sl.Visitable setChildren(tom.library.sl.Visitable[] children) {for (int i = 0; i < getChildCount(); i++) {setChildAt(i,children[i]);}return this;}public int getChildCount() { return 1; }public tom.library.sl.Visitable getChildAt(int index) {switch (index) {case 0: return super.getChildAt(0);default: throw new IndexOutOfBoundsException();}}public tom.library.sl.Visitable setChildAt(int index, tom.library.sl.Visitable child) {switch (index) {case 0: return super.setChildAt(0, child);default: throw new IndexOutOfBoundsException();}}public  tom.engine.adt.tomterm.types.TomTerm  visit_TomTerm( tom.engine.adt.tomterm.types.TomTerm  tom__arg) throws tom.library.sl.VisitFailure {if (tom_is_sort_TomTerm(tom__arg)) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch152NameNumberfreshSubject_1=(( tom.engine.adt.tomterm.types.TomTerm )tom__arg);if (tom_is_fun_sym_BackQuoteAppl(tomMatch152NameNumberfreshSubject_1)) {{  tom.engine.adt.tomoption.types.OptionList  tomMatch152NameNumber_freshVar_0=tom_get_slot_BackQuoteAppl_Option(tomMatch152NameNumberfreshSubject_1);{  tom.engine.adt.tomname.types.TomName  tomMatch152NameNumber_freshVar_1=tom_get_slot_BackQuoteAppl_AstName(tomMatch152NameNumberfreshSubject_1);{  tom.engine.adt.tomterm.types.TomList  tomMatch152NameNumber_freshVar_2=tom_get_slot_BackQuoteAppl_Args(tomMatch152NameNumberfreshSubject_1);{  tom.engine.adt.tomoption.types.OptionList  tom_optionList=tomMatch152NameNumber_freshVar_0;if (tom_is_fun_sym_Name(tomMatch152NameNumber_freshVar_1)) {{  String  tomMatch152NameNumber_freshVar_3=tom_get_slot_Name_String(tomMatch152NameNumber_freshVar_1);{  tom.engine.adt.tomname.types.TomName  tom_name=tomMatch152NameNumber_freshVar_1;if ( true ) {


          TomSymbol tomSymbol = expander.getSymbolFromName(tomMatch152NameNumber_freshVar_3);
          TomList args  = (TomList) (tom_make_ChoiceTopDown(tom_make_expandBackQuoteAppl(expander))).visit(tomMatch152NameNumber_freshVar_2);

          //System.out.println("BackQuoteTerm: " + `tomName);
          //System.out.println("tomSymbol: " + tomSymbol);
          if(TomBase.hasConstant(tom_optionList)) {
            return tom_make_BuildConstant(tom_name);
          } else if(tomSymbol != null) {
            if(TomBase.isListOperator(tomSymbol)) {
              return ASTFactory.buildList(tom_name,args,expander.symbolTable());
            } else if(TomBase.isArrayOperator(tomSymbol)) {
              return ASTFactory.buildArray(tom_name,args,expander.symbolTable());
            } else if(TomBase.isDefinedSymbol(tomSymbol)) {
              return tom_make_FunctionCall(tom_name,TomBase.getSymbolCodomain(tomSymbol),args);
            } else {
              String moduleName = TomBase.getModuleName(tom_optionList);
              if(moduleName==null) {
                moduleName = TomBase.DEFAULT_MODULE_NAME;
              }
              return tom_make_BuildTerm(tom_name,args,moduleName);
            }
          } else {
            return tom_make_FunctionCall(tom_name,tom_make_EmptyType(),args);
          }
        }}}}}}}}}}}return super.visit_TomTerm(tom__arg); }}private static  tom.library.sl.Strategy  tom_make_expandBackQuoteAppl( Expander  t0) { return new expandBackQuoteAppl(t0); }



    private static TomList sortAttributeList(TomList attrList) {
      if (tom_is_sort_TomList(attrList)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumberfreshSubject_1=(( tom.engine.adt.tomterm.types.TomList )attrList);if (tom_is_fun_sym_concTomTerm(tomMatch154NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_freshVar_0=tomMatch154NameNumberfreshSubject_1;if (tom_is_empty_concTomTerm_TomList(tomMatch154NameNumber_freshVar_0)) {if ( true ) {
 return attrList; }}}}if (tom_is_fun_sym_concTomTerm(tomMatch154NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_freshVar_1=tomMatch154NameNumberfreshSubject_1;{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_begin_3=tomMatch154NameNumber_freshVar_1;{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_end_4=tomMatch154NameNumber_freshVar_1;do {{{  tom.engine.adt.tomterm.types.TomList  tom_X1=tom_get_slice_concTomTerm(tomMatch154NameNumber_begin_3,tomMatch154NameNumber_end_4,tom_empty_list_concTomTerm());{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_freshVar_2=tomMatch154NameNumber_end_4;if (!(tom_is_empty_concTomTerm_TomList(tomMatch154NameNumber_freshVar_2))) {{  tom.engine.adt.tomterm.types.TomTerm  tom_e1=tom_get_head_concTomTerm_TomList(tomMatch154NameNumber_freshVar_2);{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_freshVar_5=tom_get_tail_concTomTerm_TomList(tomMatch154NameNumber_freshVar_2);{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_begin_7=tomMatch154NameNumber_freshVar_5;{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_end_8=tomMatch154NameNumber_freshVar_5;do {{{  tom.engine.adt.tomterm.types.TomList  tom_X2=tom_get_slice_concTomTerm(tomMatch154NameNumber_begin_7,tomMatch154NameNumber_end_8,tom_empty_list_concTomTerm());{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_freshVar_6=tomMatch154NameNumber_end_8;if (!(tom_is_empty_concTomTerm_TomList(tomMatch154NameNumber_freshVar_6))) {{  tom.engine.adt.tomterm.types.TomTerm  tom_e2=tom_get_head_concTomTerm_TomList(tomMatch154NameNumber_freshVar_6);{  tom.engine.adt.tomterm.types.TomList  tomMatch154NameNumber_freshVar_9=tom_get_tail_concTomTerm_TomList(tomMatch154NameNumber_freshVar_6);{  tom.engine.adt.tomterm.types.TomList  tom_X3=tomMatch154NameNumber_freshVar_9;if ( true ) {if (tom_is_sort_TomTerm(tom_e1)) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch153NameNumberfreshSubject_1=(( tom.engine.adt.tomterm.types.TomTerm )tom_e1);if (tom_is_sort_TomTerm(tom_e2)) {{  tom.engine.adt.tomterm.types.TomTerm  tomMatch153NameNumberfreshSubject_2=(( tom.engine.adt.tomterm.types.TomTerm )tom_e2);if (tom_is_fun_sym_TermAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_0=tom_get_slot_TermAppl_Args(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_0)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_2=tomMatch153NameNumber_freshVar_0;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_2))) {if (tom_is_fun_sym_RecordAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_2))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_8=tom_get_slot_RecordAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_2));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_8)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_10=tomMatch153NameNumber_freshVar_8;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_10))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_10))) {{  String  tomMatch153NameNumber_freshVar_14=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_10));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_11=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_10);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_11)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_3=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_2);if (tom_is_fun_sym_TermAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_1=tom_get_slot_TermAppl_Args(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_5=tomMatch153NameNumber_freshVar_1;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_5))) {if (tom_is_fun_sym_RecordAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_5))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_9=tom_get_slot_RecordAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_5));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_9)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_12=tomMatch153NameNumber_freshVar_9;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_12))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_12))) {{  String  tomMatch153NameNumber_freshVar_15=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_12));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_13=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_12);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_13)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_6=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_5);if ( true ) {




                if(tomMatch153NameNumber_freshVar_15.compareTo(tomMatch153NameNumber_freshVar_14) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if (tom_is_fun_sym_TermAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_16=tom_get_slot_TermAppl_Args(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_16)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_18=tomMatch153NameNumber_freshVar_16;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_18))) {if (tom_is_fun_sym_TermAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_18))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_24=tom_get_slot_TermAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_18));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_24)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_26=tomMatch153NameNumber_freshVar_24;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_26))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_26))) {{  String  tomMatch153NameNumber_freshVar_30=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_26));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_27=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_26);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_27)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_19=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_18);if (tom_is_fun_sym_TermAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_17=tom_get_slot_TermAppl_Args(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_17)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_21=tomMatch153NameNumber_freshVar_17;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_21))) {if (tom_is_fun_sym_TermAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_21))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_25=tom_get_slot_TermAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_21));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_25)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_28=tomMatch153NameNumber_freshVar_25;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_28))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_28))) {{  String  tomMatch153NameNumber_freshVar_31=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_28));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_29=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_28);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_29)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_22=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_21);if ( true ) {



                if(tomMatch153NameNumber_freshVar_31.compareTo(tomMatch153NameNumber_freshVar_30) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if (tom_is_fun_sym_RecordAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_32=tom_get_slot_RecordAppl_Slots(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concSlot(tomMatch153NameNumber_freshVar_32)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_34=tomMatch153NameNumber_freshVar_32;if (!(tom_is_empty_concSlot_SlotList(tomMatch153NameNumber_freshVar_34))) {if (tom_is_fun_sym_PairSlotAppl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_34))) {{  tom.engine.adt.tomname.types.TomName  tomMatch153NameNumber_freshVar_40=tom_get_slot_PairSlotAppl_SlotName(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_34));{  tom.engine.adt.tomterm.types.TomTerm  tomMatch153NameNumber_freshVar_41=tom_get_slot_PairSlotAppl_Appl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_34));if (tom_is_fun_sym_RecordAppl(tomMatch153NameNumber_freshVar_41)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_42=tom_get_slot_RecordAppl_NameList(tomMatch153NameNumber_freshVar_41);if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_42)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_46=tomMatch153NameNumber_freshVar_42;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_46))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_46))) {{  String  tomMatch153NameNumber_freshVar_50=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_46));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_47=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_46);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_47)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_35=tom_get_tail_concSlot_SlotList(tomMatch153NameNumber_freshVar_34);if (tom_is_fun_sym_RecordAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_33=tom_get_slot_RecordAppl_Slots(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concSlot(tomMatch153NameNumber_freshVar_33)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_37=tomMatch153NameNumber_freshVar_33;if (!(tom_is_empty_concSlot_SlotList(tomMatch153NameNumber_freshVar_37))) {if (tom_is_fun_sym_PairSlotAppl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_37))) {{  tom.engine.adt.tomname.types.TomName  tomMatch153NameNumber_freshVar_43=tom_get_slot_PairSlotAppl_SlotName(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_37));{  tom.engine.adt.tomterm.types.TomTerm  tomMatch153NameNumber_freshVar_44=tom_get_slot_PairSlotAppl_Appl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_37));if (tom_equal_term_TomName(tomMatch153NameNumber_freshVar_40, tomMatch153NameNumber_freshVar_43)) {if (tom_is_fun_sym_RecordAppl(tomMatch153NameNumber_freshVar_44)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_45=tom_get_slot_RecordAppl_NameList(tomMatch153NameNumber_freshVar_44);if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_45)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_48=tomMatch153NameNumber_freshVar_45;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_48))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_48))) {{  String  tomMatch153NameNumber_freshVar_51=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_48));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_49=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_48);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_49)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_38=tom_get_tail_concSlot_SlotList(tomMatch153NameNumber_freshVar_37);if ( true ) {



                if(tomMatch153NameNumber_freshVar_51.compareTo(tomMatch153NameNumber_freshVar_50) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if (tom_is_fun_sym_RecordAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_52=tom_get_slot_RecordAppl_Slots(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concSlot(tomMatch153NameNumber_freshVar_52)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_54=tomMatch153NameNumber_freshVar_52;if (!(tom_is_empty_concSlot_SlotList(tomMatch153NameNumber_freshVar_54))) {if (tom_is_fun_sym_PairSlotAppl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_54))) {{  tom.engine.adt.tomname.types.TomName  tomMatch153NameNumber_freshVar_60=tom_get_slot_PairSlotAppl_SlotName(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_54));{  tom.engine.adt.tomterm.types.TomTerm  tomMatch153NameNumber_freshVar_61=tom_get_slot_PairSlotAppl_Appl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_54));if (tom_is_fun_sym_TermAppl(tomMatch153NameNumber_freshVar_61)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_62=tom_get_slot_TermAppl_NameList(tomMatch153NameNumber_freshVar_61);if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_62)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_66=tomMatch153NameNumber_freshVar_62;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_66))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_66))) {{  String  tomMatch153NameNumber_freshVar_70=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_66));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_67=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_66);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_67)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_55=tom_get_tail_concSlot_SlotList(tomMatch153NameNumber_freshVar_54);if (tom_is_fun_sym_RecordAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_53=tom_get_slot_RecordAppl_Slots(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concSlot(tomMatch153NameNumber_freshVar_53)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_57=tomMatch153NameNumber_freshVar_53;if (!(tom_is_empty_concSlot_SlotList(tomMatch153NameNumber_freshVar_57))) {if (tom_is_fun_sym_PairSlotAppl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_57))) {{  tom.engine.adt.tomname.types.TomName  tomMatch153NameNumber_freshVar_63=tom_get_slot_PairSlotAppl_SlotName(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_57));{  tom.engine.adt.tomterm.types.TomTerm  tomMatch153NameNumber_freshVar_64=tom_get_slot_PairSlotAppl_Appl(tom_get_head_concSlot_SlotList(tomMatch153NameNumber_freshVar_57));if (tom_equal_term_TomName(tomMatch153NameNumber_freshVar_60, tomMatch153NameNumber_freshVar_63)) {if (tom_is_fun_sym_TermAppl(tomMatch153NameNumber_freshVar_64)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_65=tom_get_slot_TermAppl_NameList(tomMatch153NameNumber_freshVar_64);if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_65)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_68=tomMatch153NameNumber_freshVar_65;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_68))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_68))) {{  String  tomMatch153NameNumber_freshVar_71=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_68));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_69=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_68);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_69)) {{  tom.engine.adt.tomslot.types.SlotList  tomMatch153NameNumber_freshVar_58=tom_get_tail_concSlot_SlotList(tomMatch153NameNumber_freshVar_57);if ( true ) {



                if(tomMatch153NameNumber_freshVar_71.compareTo(tomMatch153NameNumber_freshVar_70) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if (tom_is_fun_sym_BackQuoteAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_72=tom_get_slot_BackQuoteAppl_Args(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_72)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_74=tomMatch153NameNumber_freshVar_72;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_74))) {if (tom_is_fun_sym_RecordAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_74))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_80=tom_get_slot_RecordAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_74));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_80)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_82=tomMatch153NameNumber_freshVar_80;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_82))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_82))) {{  String  tomMatch153NameNumber_freshVar_86=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_82));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_83=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_82);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_83)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_75=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_74);if (tom_is_fun_sym_BackQuoteAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_73=tom_get_slot_BackQuoteAppl_Args(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_73)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_77=tomMatch153NameNumber_freshVar_73;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_77))) {if (tom_is_fun_sym_RecordAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_77))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_81=tom_get_slot_RecordAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_77));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_81)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_84=tomMatch153NameNumber_freshVar_81;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_84))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_84))) {{  String  tomMatch153NameNumber_freshVar_87=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_84));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_85=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_84);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_85)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_78=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_77);if ( true ) {



                if(tomMatch153NameNumber_freshVar_87.compareTo(tomMatch153NameNumber_freshVar_86) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if (tom_is_fun_sym_BackQuoteAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_88=tom_get_slot_BackQuoteAppl_Args(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_88)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_90=tomMatch153NameNumber_freshVar_88;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_90))) {if (tom_is_fun_sym_TermAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_90))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_96=tom_get_slot_TermAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_90));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_96)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_98=tomMatch153NameNumber_freshVar_96;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_98))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_98))) {{  String  tomMatch153NameNumber_freshVar_102=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_98));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_99=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_98);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_99)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_91=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_90);if (tom_is_fun_sym_BackQuoteAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_89=tom_get_slot_BackQuoteAppl_Args(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_89)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_93=tomMatch153NameNumber_freshVar_89;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_93))) {if (tom_is_fun_sym_TermAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_93))) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_97=tom_get_slot_TermAppl_NameList(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_93));if (tom_is_fun_sym_concTomName(tomMatch153NameNumber_freshVar_97)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_100=tomMatch153NameNumber_freshVar_97;if (!(tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_100))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_100))) {{  String  tomMatch153NameNumber_freshVar_103=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch153NameNumber_freshVar_100));{  tom.engine.adt.tomname.types.TomNameList  tomMatch153NameNumber_freshVar_101=tom_get_tail_concTomName_TomNameList(tomMatch153NameNumber_freshVar_100);if (tom_is_empty_concTomName_TomNameList(tomMatch153NameNumber_freshVar_101)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_94=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_93);if ( true ) {



                if(tomMatch153NameNumber_freshVar_103.compareTo(tomMatch153NameNumber_freshVar_102) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if (tom_is_fun_sym_BackQuoteAppl(tomMatch153NameNumberfreshSubject_2)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_104=tom_get_slot_BackQuoteAppl_Args(tomMatch153NameNumberfreshSubject_2);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_104)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_106=tomMatch153NameNumber_freshVar_104;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_106))) {if (tom_is_fun_sym_BackQuoteAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_106))) {{  tom.engine.adt.tomname.types.TomName  tomMatch153NameNumber_freshVar_112=tom_get_slot_BackQuoteAppl_AstName(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_106));if (tom_is_fun_sym_Name(tomMatch153NameNumber_freshVar_112)) {{  String  tomMatch153NameNumber_freshVar_113=tom_get_slot_Name_String(tomMatch153NameNumber_freshVar_112);{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_107=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_106);if (tom_is_fun_sym_BackQuoteAppl(tomMatch153NameNumberfreshSubject_1)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_105=tom_get_slot_BackQuoteAppl_Args(tomMatch153NameNumberfreshSubject_1);if (tom_is_fun_sym_concTomTerm(tomMatch153NameNumber_freshVar_105)) {{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_109=tomMatch153NameNumber_freshVar_105;if (!(tom_is_empty_concTomTerm_TomList(tomMatch153NameNumber_freshVar_109))) {if (tom_is_fun_sym_BackQuoteAppl(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_109))) {{  tom.engine.adt.tomname.types.TomName  tomMatch153NameNumber_freshVar_114=tom_get_slot_BackQuoteAppl_AstName(tom_get_head_concTomTerm_TomList(tomMatch153NameNumber_freshVar_109));if (tom_is_fun_sym_Name(tomMatch153NameNumber_freshVar_114)) {{  String  tomMatch153NameNumber_freshVar_115=tom_get_slot_Name_String(tomMatch153NameNumber_freshVar_114);{  tom.engine.adt.tomterm.types.TomList  tomMatch153NameNumber_freshVar_110=tom_get_tail_concTomTerm_TomList(tomMatch153NameNumber_freshVar_109);if ( true ) {



                if(tomMatch153NameNumber_freshVar_115.compareTo(tomMatch153NameNumber_freshVar_113) > 0) {
                  return sortAttributeList(tom_append_list_concTomTerm(tom_X1,tom_cons_list_concTomTerm(tom_e2,tom_append_list_concTomTerm(tom_X2,tom_cons_list_concTomTerm(tom_e1,tom_append_list_concTomTerm(tom_X3,tom_empty_list_concTomTerm()))))));
                }
              }}}}}}}}}}}}}}}}}}}}}}}}}

        }}}}}}}if (tom_is_empty_concTomTerm_TomList(tomMatch154NameNumber_end_8)) {tomMatch154NameNumber_end_8=tomMatch154NameNumber_begin_7;} else {tomMatch154NameNumber_end_8=tom_get_tail_concTomTerm_TomList(tomMatch154NameNumber_end_8);}}} while(!(tom_equal_term_TomList(tomMatch154NameNumber_end_8, tomMatch154NameNumber_begin_7)));}}}}}}}if (tom_is_empty_concTomTerm_TomList(tomMatch154NameNumber_end_4)) {tomMatch154NameNumber_end_4=tomMatch154NameNumber_begin_3;} else {tomMatch154NameNumber_end_4=tom_get_tail_concTomTerm_TomList(tomMatch154NameNumber_end_4);}}} while(!(tom_equal_term_TomList(tomMatch154NameNumber_end_4, tomMatch154NameNumber_begin_3)));}}}}}}

      return attrList;
    }

    private static OptionList convertOriginTracking(String name,OptionList optionList) {
      Option originTracking = TomBase.findOriginTracking(optionList);
      if (tom_is_sort_Option(originTracking)) {{  tom.engine.adt.tomoption.types.Option  tomMatch155NameNumberfreshSubject_1=(( tom.engine.adt.tomoption.types.Option )originTracking);if (tom_is_fun_sym_OriginTracking(tomMatch155NameNumberfreshSubject_1)) {{  int  tomMatch155NameNumber_freshVar_0=tom_get_slot_OriginTracking_Line(tomMatch155NameNumberfreshSubject_1);{  String  tomMatch155NameNumber_freshVar_1=tom_get_slot_OriginTracking_FileName(tomMatch155NameNumberfreshSubject_1);if ( true ) {

          return tom_cons_list_concOption(tom_make_OriginTracking(tom_make_Name(name),tomMatch155NameNumber_freshVar_0,tomMatch155NameNumber_freshVar_1),tom_empty_list_concOption());
        }}}}}}

      System.out.println("Warning: no OriginTracking information");
      return tom_empty_list_concOption();
    }

    protected TomTerm expandXMLAppl(OptionList optionList, TomNameList nameList,
        TomList attrList, TomList childList, ConstraintList constraints) {
      boolean implicitAttribute = TomBase.hasImplicitXMLAttribut(optionList);
      boolean implicitChild     = TomBase.hasImplicitXMLChild(optionList);

      TomList newAttrList  = tom_empty_list_concTomTerm();
      TomList newChildList = tom_empty_list_concTomTerm();
      TomTerm star = tom_make_UnamedVariableStar(convertOriginTracking("_*",optionList),tom_make_TomTypeAlone("unknown type"),tom_empty_list_concConstraint());
      if(implicitAttribute) { newAttrList  = tom_cons_list_concTomTerm(star,tom_append_list_concTomTerm(newAttrList,tom_empty_list_concTomTerm())); }
      if(implicitChild)     { newChildList = tom_cons_list_concTomTerm(star,tom_append_list_concTomTerm(newChildList,tom_empty_list_concTomTerm())); }

      /*
       * the list of attributes should not be expanded before the sort
       * the sortAttribute is extended to compare RecordAppl
       */

      //System.out.println("attrList = " + attrList);
      attrList = sortAttributeList(attrList);
      //System.out.println("sorted attrList = " + attrList);

      /*
       * Attributes: go from implicit notation to explicit notation
       */
      Strategy expandStrategy = tom_make_ChoiceTopDown(tom_make_expandTermApplTomSyntax(this));
      while(!attrList.isEmptyconcTomTerm()) {
        try {
          TomTerm newPattern = (TomTerm) expandStrategy.visit(attrList.getHeadconcTomTerm());
          newAttrList = tom_cons_list_concTomTerm(newPattern,tom_append_list_concTomTerm(newAttrList,tom_empty_list_concTomTerm()));
          if(implicitAttribute) {
            newAttrList = tom_cons_list_concTomTerm(star,tom_append_list_concTomTerm(newAttrList,tom_empty_list_concTomTerm()));
          }
          attrList = attrList.getTailconcTomTerm();
        } catch(tom.library.sl.VisitFailure e) {}
      }
      newAttrList = ASTFactory.reverse(newAttrList);

      /*
       * Childs: go from implicit notation to explicit notation
       */
      while(!childList.isEmptyconcTomTerm()) {
        try {
          TomTerm newPattern = (TomTerm) expandStrategy.visit(childList.getHeadconcTomTerm());
          newChildList = tom_cons_list_concTomTerm(newPattern,tom_append_list_concTomTerm(newChildList,tom_empty_list_concTomTerm()));
          if(implicitChild) {
            if(newPattern.isVariableStar()) {
              // remove the previously inserted pattern
              newChildList = newChildList.getTailconcTomTerm();
              if(newChildList.getHeadconcTomTerm().isUnamedVariableStar()) {
                // remove the previously inserted star
                newChildList = newChildList.getTailconcTomTerm();
              }
              // re-insert the pattern
              newChildList = tom_cons_list_concTomTerm(newPattern,tom_append_list_concTomTerm(newChildList,tom_empty_list_concTomTerm()));
            } else {
              newChildList = tom_cons_list_concTomTerm(star,tom_append_list_concTomTerm(newChildList,tom_empty_list_concTomTerm()));
            }
          }
          childList = childList.getTailconcTomTerm();
        }catch(tom.library.sl.VisitFailure e){}
      }
      newChildList = ASTFactory.reverse(newChildList);

      /*
       * encode the name and put it into the table of symbols
       */
      TomNameList newNameList = tom_empty_list_concTomName();
matchBlock: 
      {
        if (tom_is_sort_TomNameList(nameList)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumberfreshSubject_1=(( tom.engine.adt.tomname.types.TomNameList )nameList);if (tom_is_fun_sym_concTomName(tomMatch156NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_freshVar_0=tomMatch156NameNumberfreshSubject_1;if (!(tom_is_empty_concTomName_TomNameList(tomMatch156NameNumber_freshVar_0))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch156NameNumber_freshVar_0))) {{  String  tomMatch156NameNumber_freshVar_2=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch156NameNumber_freshVar_0));if (tom_equal_term_String("_", tomMatch156NameNumber_freshVar_2)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_freshVar_1=tom_get_tail_concTomName_TomNameList(tomMatch156NameNumber_freshVar_0);if (tom_is_empty_concTomName_TomNameList(tomMatch156NameNumber_freshVar_1)) {if ( true ) {

            break matchBlock;
          }}}}}}}}}if (tom_is_fun_sym_concTomName(tomMatch156NameNumberfreshSubject_1)) {{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_freshVar_3=tomMatch156NameNumberfreshSubject_1;{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_begin_5=tomMatch156NameNumber_freshVar_3;{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_end_6=tomMatch156NameNumber_freshVar_3;do {{{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_freshVar_4=tomMatch156NameNumber_end_6;if (!(tom_is_empty_concTomName_TomNameList(tomMatch156NameNumber_freshVar_4))) {if (tom_is_fun_sym_Name(tom_get_head_concTomName_TomNameList(tomMatch156NameNumber_freshVar_4))) {{  String  tomMatch156NameNumber_freshVar_9=tom_get_slot_Name_String(tom_get_head_concTomName_TomNameList(tomMatch156NameNumber_freshVar_4));{  tom.engine.adt.tomname.types.TomNameList  tomMatch156NameNumber_freshVar_7=tom_get_tail_concTomName_TomNameList(tomMatch156NameNumber_freshVar_4);if ( true ) {


            newNameList = tom_append_list_concTomName(newNameList,tom_cons_list_concTomName(tom_make_Name(ASTFactory.encodeXMLString(symbolTable(),tomMatch156NameNumber_freshVar_9)),tom_empty_list_concTomName()));
          }}}}}}if (tom_is_empty_concTomName_TomNameList(tomMatch156NameNumber_end_6)) {tomMatch156NameNumber_end_6=tomMatch156NameNumber_begin_5;} else {tomMatch156NameNumber_end_6=tom_get_tail_concTomName_TomNameList(tomMatch156NameNumber_end_6);}}} while(!(tom_equal_term_TomNameList(tomMatch156NameNumber_end_6, tomMatch156NameNumber_begin_5)));}}}}}}

      }

      /*
       * a single "_" is converted into an UnamedVariable to match
       * any XML node
       */
      TomTerm xmlHead;

      if(newNameList.isEmptyconcTomName()) {
        xmlHead = tom_make_UnamedVariable(tom_empty_list_concOption(),tom_make_TomTypeAlone("unknown type"),tom_empty_list_concConstraint());
      } else {
        xmlHead = tom_make_TermAppl(convertOriginTracking(newNameList.getHeadconcTomName().getString(),optionList),newNameList,tom_empty_list_concTomTerm(),tom_empty_list_concConstraint());
      }
      try {
        //VisitableVisitor expandStrategy = (ChoiceTopDown(expandTermApplTomSyntax(this)));
        SlotList newArgs = tom_cons_list_concSlot(tom_make_PairSlotAppl(tom_make_Name(Constants.SLOT_NAME),(TomTerm) expandStrategy.visit(xmlHead)),tom_cons_list_concSlot(tom_make_PairSlotAppl(tom_make_Name(Constants.SLOT_ATTRLIST),(TomTerm) expandStrategy.visit(tom_make_TermAppl(convertOriginTracking("CONC_TNODE",optionList),tom_cons_list_concTomName(tom_make_Name(Constants.CONC_TNODE),tom_empty_list_concTomName()),newAttrList,tom_empty_list_concConstraint()))),tom_cons_list_concSlot(tom_make_PairSlotAppl(tom_make_Name(Constants.SLOT_CHILDLIST),(TomTerm) expandStrategy.visit(tom_make_TermAppl(convertOriginTracking("CONC_TNODE",optionList),tom_cons_list_concTomName(tom_make_Name(Constants.CONC_TNODE),tom_empty_list_concTomName()),newChildList,tom_empty_list_concConstraint()))),tom_empty_list_concSlot())))





;

        TomTerm result = tom_make_RecordAppl(optionList,tom_cons_list_concTomName(tom_make_Name(Constants.ELEMENT_NODE),tom_empty_list_concTomName()),newArgs,constraints);

        //System.out.println("expandXML out:\n" + result);
        return result;
      } catch(tom.library.sl.VisitFailure e) {
        //must never be executed
        return star;
      }
    }
  }
